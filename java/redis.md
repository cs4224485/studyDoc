# 一 Redis简介

## 1、什么是redis

​    Redis是一个开源（BSD许可），**内存存储的数据结构服务器，可用作数据库，高速缓存和消息队列代理。它支持字符串、哈希表、列表、集合、有序集合，位图，hyperloglogs等数据类型**。内置复制、Lua脚本、LRU收回、事务以及不同级别磁盘持久化功能，同时通过Redis
Sentinel提供高可用，通过Redis Cluster提供自动分区。

   Redis属于**NoSQL**类型数据，即非关系型数据库。

## 2、什么是NoSQL

NoSQL，**泛指非关系型的数据库**。随着互联网web2.0网站的兴起，传统的关系数据库在处理web2.0网站，特别是超大规模和高并发的SNS类型的web2.0纯动态网站已经显得力不从心，出现了很多难以克服的问题，而非关系型的数据库则由于其本身的特点得到了非常迅速的发展。NoSQL数据库的产生就是为了解决大规模数据集合多重数据种类带来的挑战，尤其是大数据应用难题。

NoSQL，即：**not only sql**

RDBMS VS NoSQL

RDBMS：  	

	1. 高度组织化结构化数据  	
 	2. 结构化查询语言(SQL)  	
 	3. 数据和关系都存储在单独的表中  	
 	4. 数据操纵语言，数据定义语言  	
 	5. 严格的一致性  	6. 基础事务(ACDI属性)  

NoSQL：

	1. 代表着不仅仅是SQL  	
 	2.  没有声明性查询语言  	
 	3. 没有预定义的模式  	
 	4. 键-值对存储，列存储，文档存储，图形数据库  	
 	5.  最终一致性，而非ACID属性

## 3、为什么使用NoSQL

   随着互联网飞速发展，数据访问量和存储量高速扩大，传统的架构APP访问DAL层，DAL层再查询直接通过关系型数据库(比如MYSQL数据库)获取数据返回给用用户已然出现了性能问题。为了解决这个问题，需要对数据库和数据库表的水平拆分和垂直拆分

![image-20201129113730065](\images\image-20201129113730065.png)

### 分布式缓存+MySQL+垂直拆分

![image-20201129113806498](\images\image-20201129113806498.png)

​    后来，随着访问量的上升，几乎大部分使用MySQL架构的网站在数据库上都开始出现了性能问题，web程序不再仅仅专注在功能上，同时也在追求性能。程序员们开始大量的使用缓存技术来缓解数据库的压力，优化数据库的结构和索引。开始比较流行的是通过文件缓存来缓解数据库压力，但是当访问量继续增大的时候，多台web机器通过文件缓存不能共享，大量的小文件缓存也带了了比较高的IO压力。在这个时候，分布式缓存就自然的成为一个非常时尚的技术产品。

​    数据库拆分之后就会出现多了多个数据库，多个数据库有分别部署在了不同的服务器，这时就需要对数据库进行集群，为了保证多台机器的缓存一致性、可用性和分区容错性，分布式缓存(比如Redis)的诞生正好解决了这个痛点。

​    分布式缓存为多个web服务器提供了一个共享的高性能缓存服务。

### Mysql主从读写分离

​    由于数据库的写入压力增加，分布式缓存只能缓解数据库的读取压力。读写集中在一个数据库上让数据库不堪重负，大部分网站开始使用主从复制技术来达到读写分离，以提高读写性能和读库的可扩展性。Mysql的master-slave模式成为这个时候的网站标配了。

### 分库分表+水平拆分+mysql集群

![image-20201129114032267](\images\image-20201129114032267.png)

```
在分布式的高速缓存，MySQL的主从复制，读写分离的基础之上，这时MySQL主库的写压力开始出现瓶颈，而数据量的持续猛增，由于MyISAM在写数据的时候会使用表锁，在高并发写数据的情况下会出现严重的锁问题，大量的高并发MySQL应用开始使用InnoDB引擎代替MyISAM。
同时，开始流行使用分表分库来缓解写压力和数据增长的扩展问题。这个时候，分表分库成了以一个热门技术， 也是面试的热门问题也是业界讨论的热门技术问题。也就在这个时候，MySQL推出了还不太稳定的表分区，这也 给技术实力一般的公司带来 了希望。虽然MySQL推出了MySQL Cluster集群，但性能也不能很好满足互联网 的要求，只是在高可靠性上提供了非常大的保证。
```

## 4、NoSQL分类

1. 键值(Key-Value)存储数据库
   这一类数据库主要会使用到一个哈希表，这个表中有一个特定的键和一个指针指向特定的数据。Key/value模型对于IT系统来说的优势在于简单、易部署。但是如果数据库管理员(DBA)只对部分值进行查询或更新的时候，Key/value就显得效率低下了。举例如：Tokyo Cabinet/Tyrant， Redis， Voldemort， Oracle BDB。
2. 列存储数据库
   这部分数据库通常是用来应对分布式存储的海量数据。键仍然存在，但是它们的特点是指向了多个列。这些列是由列家族来安排的。如：Cassandra， HBase， Riak.
3. 文档型数据库
   文档型数据库的灵感是来自于Lotus Notes办公软件的，而且它同第一种键值存储相类似。该类型的数据模型是版本化的文档，半结构化的文档以特定的格式存储，比如JSON。文档型数据库可以看作是键值数据库的升级版，允许之间嵌套键值，在处理网页等复杂数据时，文档型数据库比传统键值数据库的查询效率更高。如：CouchDB， MongoDb. 国内也有文档型数据库SequoiaDB，已经开源。
4. 图形(Graph)数据库
   图形结构的数据库同其他行列以及刚性结构的SQL数据库不同，它是使用灵活的图形模型，并且能够扩展到多个服务器上。NoSQL数据库没有标准的查询语言(SQL)，因此进行数据库查询需要制定数据模型。许多NoSQL数据库都有REST式的数据接口或者查询API。如：Neo4J， InfoGrid， Infinite Graph。



## 5、NoSQL特性

- C：consistency，数据在多个副本中能保持一致的状态。
- A：Availability，整个系统在任何时刻都能提供可用的服务，通常达到99.99%四个九可以称为高可用
- P：Partition tolerance，分区容错性，在分布式中，由于网络的原因无法避免有时候出现数据不一致的情况，系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择，换句话说，系统可以跨网络分区线性的伸缩和扩展。

CAP理论的核心：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，最多只能同时较好的满足两个。

CA：单点集群，满足一致性，可用性的系统，通常在可扩展上不太强大。应用：传统的Oracle数据库
CP：满足一致性，分区容错性的系统，通常性能不是特别高。应用：Redis，MongoDB，银行
AP：满足可用性，分区容错性，通常可能对一致性要求低一些。应用：大多数网站架构的选择

![image-20201129114438987](\images\image-20201129114438987.png)

- CAP理论就是说在分布式存储系统中，最多只能实现上面的两个。而由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性（P）是我们必须需要实现的。所以在分布式系统中，根据不同的情况选择使用AP或者CP模式。

- 分布式和集群
  `分布式：不同的多台服务器上面部署不同的服务模块（工程）`
  `集群：不同的多台服务器上面部署相同的服务模块。通过分布式调度软件进行统一的调度，对外提供服务和访问`

- 为何CAP三者不可兼得?

  假设有两台服务器，一台放着应用A和数据库DB0，一台放着应用B和数据库DBI，他们之间的网络可以互通，也就相当于分布式系统的两个部分。

  在满足一致性(C)的时候，一开始两台服务器的数据是一样的，DB0=DBI。在满足可用性(A)的时候，用户不管是请求服务器1还是服务器2，都会得到立即响应。在满足分区容错性(P)的情况下，两台有任何一方宕机，或者网络不通的时候，都不会影响彼此之间的正常运作。

![image-20201129114629431](\images\image-20201129114629431.png)

​    在两台服务器正常通讯的情况下，当服务器1通过应用A请求更新数据库DB0的时候，通过分布式系统系统的同步更新操作，服务器2的数据也由DBI更新到了DBII，此时DB1=DBII，这时用户通过服务器2向数据库发起请求得到的数据就是最新的数据

​    上面是正常运作的情况，但分布式系统中，最大的问题就是网络传输问题，现在假设一种极端情况，服务器1和服务器2之间的网络断开了，但我们仍要支持这种网络异常，也就是满足分区容错性(P)，那么这样能不能同时满足一致性(C)和可用性(A)呢？

![image-20201129114818233](\images\image-20201129114818233.png)

​    假设服务器1和服务器2之间通信的时候网络突然出现故障，有用户向服务器1发送数据更新请求，那服务器1中的数据DB0将被更新为DB1，由于网络是断开的，服务器2中的数据库仍旧是DBI，这时DB1 != DBI。

​    如果这个时候，有用户向服务器2发送数据读取请求，由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据DBII，怎么办呢？有二种选择，第一，牺牲数据一致性(C)，响应旧的数据DBI给用户；第二，牺牲可用性(A)，阻塞等待，直到网络连接恢复，数据更新操作完成之后，再给用户响应最新的数据DBII。

   上面的过程比较简单，但也说明了要满足分区容错性的分布式系统，只能在一致性(C)和可用性(A)两者中，选择其中一个。也就是说分布式系统不可能同时满足三个特性。这就需要我们在搭建系统时进行取舍了。

