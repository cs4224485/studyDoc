# 一 IP组播基础简介

作为IP传输三种方式之一，IP组播（IP Multicast）指的是IP报文从一个源发出，被转发到一组特定的接收者，相同的组播数据流在每一条链路上最多仅有一份。相较于传统的单播和广播，IP组播可以有效地节约网络带宽、降低网络负载，所以被广泛应用于IPTV、实时数据传送和多媒体会议等网络业务中。



网络中交互的各种数据、语音和视频信息越来越多，同时新兴的电子商务、网上会议、网上拍卖、视频点播、远程教学等服务也在逐渐兴起。这些服务大多符合点对多点的模式，对信息安全性、有偿性、网络带宽提出了较高的要求。

传统的IP通信有两种方式：单播（Unicast）和广播（Broadcast）。对于单播通信，信息源为每个需要信息的主机都发送一份独立的报文。对于广播通信，信息源将信息发送给该网段中的所有主机，而不管其是否需要该信息。

## 组播服务模型

组播服务模型的分类是针对接收者主机的。组播源发出的组播数据中总是以组播源自己的IP地址为报文的源地址，组播组地址为目的地址。而接收者主机接收数据时可以对源进行选择，因此产生了任意源组播ASM（Any-Source Multicast）和指定源组播SSM（Source-Specific Multicast）两种服务模型。这两种服务模型使用不同的组播组地址范围。ASM模型的组播组地址范围为224.0.1.0～231.255.255.255或233.0.0.0～238.255.255.255。SSM模型的组播组地址范围为232.0.0.0～232.255.255.255

## ASM模型

ASM模型仅针对组地址提供组播分发。一个组播组地址作为一个网络服务的集合，任何源发布到该组地址的数据得到同样的服务。接收者主机加入组播组以后可以接收到任意源发送到该组的数据。

ASM模型要求组地址必须整个组播网络中唯一。“唯一”指的是同一时刻一个ASM地址只能被一种组播应用使用。如果有两种不同的应用程序使用了同一个ASM组地址发送数据，它们的接收者会同时收到来自两个源的数据。这样一方面可能会导致网络流量拥塞，另一方面也会给接收者主机造成困扰。在ASM模型中，接收者无法预先知道组播源的位置，接收者可以在任意时间加入或离开该组播组。

ASM模型下还有一种特殊的组播模型——过滤源组播SFM（Source-Filtered Multicast）。SFM在ASM模型的基础上添加了组播源过滤策略，提高了安全性。在SFM模型下，设备配置针对组播源的过滤策略，允许或禁止来自某些组播源的报文通过。从发送者角度来看，组播组成员关系完全相同；从接收者角度看，数据是经过筛选的。

## SSM模型

SSM模型针对特定源和组的绑定数据流提供服务，接收者主机在加入组播组时，可以指定只接收哪些源的数据。加入组播组以后，主机只会收到指定源发送到该组的数据。

SSM模型对组地址不再要求全网唯一，只需要每个组播源保持唯一。这里的“唯一”指的是同一个源上不同的组播应用必须使用不同的SSM地址来区分。不同的源之间可以使用相同的组地址，因为SSM模型中针对每一个（源，组）信息都会生成表项。这样一方面节省了组播组地址，另一方面也不会造成网络拥塞。

## IP组播地址

为了使组播源和组播组成员进行通信，需要提供网络层组播，使用IP组播地址。同时，为了在本地物理网络上实现组播信息的正确传输，需要提供链路层组播，使用组播MAC地址。组播数据传输时，其目的地不是一个具体的接收者，而是一个成员不确定的组，所以需要将IP组播地址映射为组播MAC地址。

ANA（Internet Assigned Numbers Authority，互联网编号分配委员会）将D类地址空间分配给IPv4组播使用。IPv4地址一共32位，D类地址最高4位为1110，因此地址范围从224.0.0.0到239.255.255.255

| 地址范围                                             | 含义                                                         |
| ---------------------------------------------------- | ------------------------------------------------------------ |
| 224.0.0.0～224.0.0.255                               | 永久组地址范围。IANA为路由协议预留的IP地址范围（也称为保留组地址范围），用于标识一组特定的网络设备，供路由协议、拓扑查找等使用，不用于组播转发。 |
| 224.0.1.0～231.255.255.255233.0.0.0～238.255.255.255 | ASM组播地址范围，全网范围内有效。**说明：**其中，224.0.1.39和224.0.1.40是保留地址，不建议使用。 |
| 232.0.0.0～232.255.255.255                           | 缺省情况下的SSM组播地址范围，全网范围内有效。                |
| 239.0.0.0～239.255.255.255                           | 本地管理组地址范围，仅在本地管理域内有效。在不同的管理域内重复使用相同的本地管理组地址不会导致冲突。 |

| 永久组地址                                        | 含义                                                         |
| ------------------------------------------------- | ------------------------------------------------------------ |
| 224.0.0.0                                         | 不分配                                                       |
| 224.0.0.1                                         | 网段内所有主机和组播设备的地址（等效于广播地址）             |
| 224.0.0.2                                         | 所有组播设备的地址                                           |
| 224.0.0.3                                         | 不分配                                                       |
| 224.0.0.4                                         | DVMRP（Distance Vector Multicast Routing Protocol，距离矢量组播路由协议）路由器的地址 |
| 224.0.0.5                                         | OSPF（Open Shortest Path First，开放最短路径优先）路由器的地址 |
| 224.0.0.6                                         | OSPF DR（Designated Router，指定路由器）的地址               |
| 224.0.0.7                                         | ST（Shared Tree，共享树）路由器的地址                        |
| 224.0.0.8                                         | ST主机的地址                                                 |
| 224.0.0.9                                         | RIP-2（Routing Information Protocol version 2，路由信息协议版本2）路由器的地址 |
| 224.0.0.11                                        | 移动代理（Mobile-Agents）的地址                              |
| 224.0.0.12                                        | DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）服务器/中继代理的地址 |
| 224.0.0.13                                        | 所有PIM（Protocol Independent Multicast，协议无关组播）路由器的地址 |
| 224.0.0.14                                        | 用于RSVP（Resource Reservation Protocol，资源预留协议）封装  |
| 224.0.0.15                                        | 所有CBT（Core-Based Tree，有核树）路由器的地址               |
| 224.0.0.16                                        | 指定SBM（Subnetwork Bandwidth Management，子网带宽管理）的地址 |
| 224.0.0.17                                        | 所有SBM的地址                                                |
| 224.0.0.18                                        | VRRP（Virtual Router Redundancy Protocol，虚拟路由器冗余协议）地址 |
| 224.0.0.22                                        | 所有使能IGMPv3（Internet Group Management Protocol, Version 3，因特网组管理协议）的路由器地址 |
| 224.0.0.19 ～ 224.0.0.21224.0.0.23 ～ 224.0.0.255 | 未指定                                                       |

## IPv4组播MAC地址

以太网传输IPv4单播报文的时候，目的MAC地址使用的是接收者的MAC地址。但是在传输组播数据时，其目的地不再是一个具体的接收者，而是一个成员不确定的组，所以要使用IPv4组播MAC地址，即IPv4组播地址映射到链路层中的地址。

IANA规定，IPv4组播MAC地址的高24位为0x01005e，第25位为0，低23位为IPv4组播地址的低23位，。根据映射关系，IPv4组播地址的后28bit中只有23bit被映射到MAC地址，因此丢失了5bit的地址信息，直接结果是有32个IPv4组播地址映射到同一MAC地址上。

![image-20230610183156256](images\image-20230610183156256.png)

# 二 IPv4组播路由管理简介

IPv4组播路由管理包括以下几个功能：

- RPF单播逆向路由检查

  此功能用于查找到组播源的最优单播路由，创建组播转发树。单播路由的出接口作为转发表项中的数据入口。当转发模块收到组播数据时，在匹配转发表项的同时，还会匹配数据的入接口是否正确。如果组播数据报文实际到达接口和单播路由的出接口相同，则RPF检查通过；否则RPF检查失败，丢弃该报文。RPF单播逆向路由检查功能能够防止组播数据在转发过程中出现流量环路。

- 组播静态路由

  组播静态路由是RPF检查的重要依据。通过配置组播静态路由，用户可以在当前设备上为特定“报文源”指定RPF接口和RPF邻居。

- 组播负载分担

  在组播选路时，使用组播负载分担策略可为不同转发表项从多条等价路由中选取不同的等价路由作为RPF路由，指导数据转发。由于转发表项依赖的RPF路由能够分布在多条等价路由上，因此该功能可以达到组播数据分流的效果。

- 按照最长匹配选择路由

  在组播选路时，能够优先选取掩码长度最长的路由，以实现路由的精确匹配。

- 指定组播转发边界

  应用组播转发边界（Multicast Boundary）功能可以实现每个组播组对应的组播信息在一个确定的范围内传递。当组播设备接口配置了针对某组播组的转发边界以后，会形成一个封闭的组播转发区域，该接口将不能再发出或接收对应的组播组的报文。



## 组播路由和转发

组播网络中设备根据扮演的不同角色，需要维护不同类型的表：IGMP组表、组播协议路由表、组播路由表、组播转发表。每个组播路由协议都各自建立并维护一张协议自身的路由表，各组播路由协议的组播路由信息经过汇总形成一张总的组播路由表。最后，设备根据组播路由和转发策略，从组播路由表中选出最优的组播路由，并下发到组播转发表，直接用于控制组播数据的转发。下面介绍各表在实现组播路由和转发中所起的作用。

### IGMP组表

IGMP组表是由用户主机发送的IGMP加入报文触发创建的，用于维护组加入信息并通知组播路由协议（通常所说的为PIM协议）创建相应(*, G)表项。只要设备接口使能了IGMP并收到组加入报文就会为每个接口维护一个组加入信息表项。

### 组播协议路由表

组播协议路由表是运行各种组播路由协议时由各个协议自己维护的表项，是组播路由和转发的基础。现在应用最广泛的组播路由协议为PIM（Protocol Independent Multicast）协议无关组播。

### 组播路由表

组播路由表是组播路由管理模块生成的路由表。如果支持多种组播协议进行组播路由管理，则组播路由表中可以看到多种协议生成的优选出的路由信息。这张表类似于单播中同时运行OSPF、RIP、BGP等多种路由协议时汇总形成的IP路由表。组播路由表的主要功能就是选出最优的组播路由并下发创建组播转发表。

### 组播转发表

组播转发表是路由管理模块依据组播路由表信息生成的用于指导组播数据实际转发的表，通常称为MFIB（Multicast Forwarding Information Base）。组播转发表由一组(S, G)表项组成。(S, G)表示由组播源S向组播组G发送的组播数据的路由信息。这张表与单播中FIB（Forwarding Information Base）表的功能是一样的，用于指导组播数据转发，转发表中概括性记录了报文转发的统计信息。

## RPF单播逆向路由检查

在单播路由与转发中，单播报文沿着一条单点到单点的路径传输，设备只需要考虑报文“需要到达的位置”，即目的地址，就知道从哪个接口转发出去。组播路由与转发则不同。由于组播报文的目的地址为组播地址，只是标识了一组接收者，无法通过目的地址来找到接收者的位置，但是组播报文的“来源位置”，即源地址是确定的。所以组播报文的转发主要是根据其源地址来保证转发路径正确性。

设备收到一份组播报文后，会根据报文的源地址通过单播路由表和组播静态路由表查找到达“报文源”的路由，查看到“报文源”的路由表项的出接口是否与收到组播报文的入接口一致。如果一致，则认为该组播报文从正确的接口到达，从而保证了整个转发路径的正确性和唯一性。这个过程就被称为RPF（Reverse Path Forwarding）检查。

### RPF检查过程

当设备收到一份组播报文后，具体检查过程如下：

1. 首先，通过报文源地址，分别从单播路由表和组播静态路由表中各选出一条最优路由。单播路由的出接口为RPF接口，下一跳为RPF邻居。需要注意的是，组播静态路由实际上属于手工配置的组播路由，已经明确指定了RPF接口与RPF邻居。
2. 然后，根据以下原则从这两条最优路由中选择一条作为RPF路由。
   - 如果配置了按照最长匹配选择路由，则选出目的地址与报文源地址匹配“掩码”最长的那条路由；如果它们的掩码匹配长度一样，则选择优先级最高的那条路由；如果它们的优先级也相同，则按照组播静态路由、单播路由的顺序进行选择。
   - 如果没有配置按照最长匹配选择路由，则选出优先级最高的那条路由；如果它们的优先级相同，则按照组播静态路由、单播路由的顺序进行选择。
3. 最后，设备会将报文的入接口与RPF路由的RPF接口进行比较。如果一致则RPF检查通过，表明该报文来源路径正确，会将其向下游转发；如果不一致即RPF检查失败，表明该报文来源路径错误，就将其丢弃。

RPF失败案例

![image-20230610183756971](images\image-20230610183756971.png)

RPF成功实例

![image-20230610183850352](images\image-20230610183850352.png)

### RPF检查在组播数据转发中的应用

组播路由协议通过已有的单播路由或组播静态路由信息来确定上、下游邻居设备，创建组播路由表项。运用RPF检查机制，来确保组播数据流能够沿组播分发树（路径）正确的传输，同时可以避免转发路径上环路的产生。

在实际组播数据转发过程中，如果对每一份接收到的组播数据报文都通过单播路由表进行RPF检查，会给设备带来很大负担。因此，设备在收到一份来自源S发往组G的组播数据报文之后，首先会在组播转发表中查找有无相应的(S, G)组播转发表项：

- 如果不存在(S, G)转发表项，则对该报文执行RPF检查，将检查到的RPF接口作为入接口，创建组播路由表项，下发到组播转发表中。其中，对RPF检查结果的处理方式为：如果检查通过，表明接收接口为RPF接口，向转发表项的所有出接口转发；如果检查失败，表明报文来源路径错误，丢弃该报文。
- 如果存在(S, G)转发表项，并且接收该报文的接口与转发表项的入接口一致，则向所有的出接口转发该报文。
- 如果存在(S, G)转发表项，但是接收该报文的接口与转发表项的入接口不一致，则对此报文进行RPF检查。对RPF检查结果的处理方式为：
  - 若RPF检查选取出的RPF接口与转发表项的入接口一致，则说明(S, G)表项正确，报文来源路径错误，将其丢弃。
  - 若RPF检查选取出的RPF接口与转发表项的入接口不一致，则说明(S, G)表项已过时，于是把表项中的入接口更新为RPF接口。然后再根据RPF检查规则进行判断：如果接收该报文的接口正是其RPF接口，则向转发表项的所有出接口转发该报文，否则将其丢弃。

## 配置组播静态路由

#### 背景信息

组播静态路由是RPF检查的重要依据。通过配置组播静态路由，用户可以在当前设备上为特定“报文源”指定RPF接口和RPF邻居。

以具体应用环境区分，组播静态路由主要有两种功能：

- 改变RPF路由

  如果设备希望特定组播源发来的数据报文从指定接口接收，但是RPF检查时发现该接口不是RPF接口，此时可配置组播静态路由，指定该接口为RPF接口。当设备接收到特定源发来的组播数据报文后，会以该路由为RPF路由来执行RPF检查，不是通过指定接口发来的报文在RPF检查时将不通过。

- 衔接RPF路由

  在单播路由被阻断的网段，比如相邻两台设备配置不同的路由协议，并且路由没有相互引入，设备上会由于没有RPF路由而无法进行报文转发。此时通过配置组播静态路由，指定RPF接口来完成RPF检查，便可实现组播报文的转发。

1. 进入系统视图

   ```
   system-view
   ```

2. 使能组播功能。

   ```
   multicast routing-enable
   ```

3. 配置组播静态路由。

   ```
   ip rpf-route-static [ vpn-instance vpn-instance-name ] source-address { mask | mask-length } { rpf-nbr | { interface-n
   ```

- 执行命令**display multicast routing-table** [ **vpn-instance** *vpn-instance-name* ] **static** [ **config** ] [ *prefix* { *mask* | *masklength* } ]，查看配置组播静态路由功能是否生效。
- 执行命令**display multicast** [ **vpn-instance** *vpn-instance-name* | **all-instance** ] **rpf-info** *source-address* [ *group-address* ] [ **rpt** | **spt** ] [ **verbose** ]，查看指定组播源的RPF路由信息。

# 三 IGMP简介

## 定义

因特网组管理协议IGMP（Internet Group Management Protocol），是TCP/IP协议族中负责IPv4组播成员管理的协议，用来在IP主机和与其直接相邻的组播设备之间建立、维护组播组成员关系。

## 目的

IP组播通信的特点是报文从一个源发出，被转发到一组特定的接收者。但在组播通信模型中，发送者不关注接收者的位置信息。如图所示，要使组播报文最终能够到达接收者Host，需要某种机制使连接接收者网段的组播设备Device能够了解到该网段存在哪些组播接收者，同时保证接收者可以加入相应的组播组中。IGMP就是用来在接收者主机和与其所在网段直接相邻的组播设备之间建立、维护组播组成员关系的协议。

![image-20230610184659883](images\image-20230610184659883.png)

## IGMPv1介绍

IGMPv1协议主要基于查询和响应机制完成组播组管理。当一个网段内有多个组播设备时，由于它们都可以接收到主机发送的成员报告报文，因此只需要选取其中一台组播设备发送查询报文，该组播设备称为IGMP查询器（Querier）。在IGMPv1中，由组播路由协议PIM选举出唯一的组播信息转发者（Assert Winner或DR）作为IGMP的查询器，负责该网段的组成员关系查询。

### IGMPv1报文

IGMPv1报文封装在IP报文中，由8个字节组成。IGMPv1包括两种类型的报文：

- 普遍组查询报文（General Query）：查询器向共享网络上所有主机发送的查询报文，用于了解哪些组播组存在成员。
- 成员报告报文（Report）：主机向查询器发送的报告报文，用于申请加入某个组播组或者应答查询报文。

![image-20230610184803191](images\image-20230610184803191.png)

| 字段          | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| Version       | IGMP版本，值为1。                                            |
| Type          | 报文类型。该字段有以下两种取值：0x1：表示普遍组查询报文。0x2：表示成员报告报文。 |
| Unused        | 在IGMPv1中，该字段在发送时被设为0，并在接收时被忽略。        |
| Checksum      | 校验和。                                                     |
| Group Address | 组播组地址。在普遍组查询报文中，该字段设为0；在成员报告报文中，该字段为成员加入的组播组地址。 |

### IGMPv1工作机制

组播网络中Source为组播源，负责发送组播数据。DeviceA和DeviceB与同一网段的主机相连，DeviceA为IGMP查询器，在主机网段上有HostA、HostB、HostC三个接收者。HostA和HostB想要接收发往组播组G1的数据，HostC想要接收发往组播组G2的数据。

![image-20230610184856161](images\image-20230610184856161.png)

IGMPv1的工作机制可以分为查询组播组成员机制、新组成员加入机制和组成员离开机制三个方面。

**查询组播组成员机制**

![image-20230610184923779](images\image-20230610184923779.png)

遍组查询和响应过程如下：

1. IGMP查询器发送目的地址为224.0.0.1（表示同一网段内所有主机和设备）的普遍组查询报文；收到该查询报文的组成员启动定时器。

   普遍组查询报文是周期性发送的，发送周期可以通过命令配置。HostA和HostB作为组播组G1的成员，收到普遍组查询报文后，在本地启动定时器Timer-G1。

2. 第一个定时器超时的组成员发送针对该组的报告报文。

   假设HostA上的Timer-G1首先超时，HostA向该网段发送目的地址为G1的报告报文。也想加入组G1的HostB收到此报告报文，则停止定时器Timer-G1，不再发送针对G1的报告报文。这样报告报文被抑制，可以减少网段上的流量。

3. IGMP查询器接收到HostA的报告报文后，了解到本网段内存在组播组G1的成员，则由组播路由协议生成（*，G1）组播转发表项，“*”代表任意组播源。网络中一旦有组播组G1的数据到达DeviceA，将向该网段转发。

**新组成员加入机制**

主机HostC可以主动向查询器发送报告报文来加入组播组

HostC加入组播组G2的过程如下：

1. 主机HostC不等待普遍组查询报文的到来，主动发送针对G2的报告报文以声明加入组播组G2。
2. IGMP查询器接收到HostC的报告报文后，了解到本网段内出现了组播组G2的成员，则生成组播转发项（*，G2）。网络中一旦有G2的数据到达DeviceA，将向该网段转发。

**组成员离开机制**

IGMPv1没有专门定义离开组的报文。主机离开组播组后，停止发送成员报告报文。根据主机想要离开的组播组中是否还有其他成员，处理机制有所不同

- 假设HostA想要退出组播组G1

  HostA收到IGMP查询器发送的普遍组查询报文时，不再发送针对G1的报告报文。由于网段内还存在G1组成员HostB，HostB会向IGMP查询器发送针对G1的报告报文，因此IGMP查询器感知不到HostA的离开。

- 假设HostC想要退出组播组G2

  HostC收到IGMP查询器发送的普遍组查询报文时，不再发送针对G2的报告报文。由于网段内不存在组G2的其他成员，IGMP查询器不会收到G2组成员的报告报文，则在一定时间（缺省值为130秒）后，删除G2所对应的组播转发表项。

## IGMPv2介绍

IGMPv2的工作机制与IGMPv1基本相同，最大的不同之处在于IGMPv2增加了查询器选举和离开组机制。IGMPv2可以使IGMP查询器及时了解到网段内哪些组播组已不存在成员，从而及时更新组成员关系，减少网络中冗余的组播流量。

### IGMPv2报文

与IGMPv1相比，IGMPv2的变化如下：

- 除了普遍组查询报文和成员报告报文之外，IGMPv2新增了两种报文：
  - 成员离开报文（Leave）：成员离开组播组时主动向查询器发送的报文，用于宣告自己离开了某个组播组。
  - 特定组查询报文（Group-Specific Query）：查询器向共享网段内指定组播组发送的查询报文，用于查询该组播组是否存在成员。
- IGMPv2对普遍组查询报文格式也做了改进，添加了最大响应时间（Max Response Time）字段。此字段取值可以通过命令配置，用于控制成员对于查询报文的响应速度。

![image-20230610185340974](images\image-20230610185340974.png)

| 字段              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| Type              | 报文类型。该字段有以下四种取值：0x11：表示查询报文。IGMPv2的查询报文包括普遍组查询报文和特定组查询报文两类。0x12：表示IGMPv1成员报告报文。0x16：表示IGMPv2成员报告报文。0x17：表示成员离开报文。 |
| Max Response Time | 最大响应时间。成员主机在收到IGMP查询器发送的普遍组查询报文后，需要在最大响应时间内做出回应。该字段仅在IGMP查询报文中有效。 |
| Checksum          | 校验和。                                                     |
| Group Address     | 组播组地址。在普遍组查询报文中，该字段设为0。在特定组查询报文中，该字段为要查询的组播组地址。在成员报告报文和离开报文中，该字段为成员要加入或离开的组播组地址。 |

### IGMPv2工作机制

在工作机制上，与IGMPv1相比，IGMPv2增加了查询器选举和离开组机制。

组播网络中DeviceA和DeviceB连接主机网段，在主机网段上有HostA、HostB、HostC三个接收者。假设HostA和HostB想要接收发往组播组G1的数据，HostC想要接收发往组播组G2的数据。

![image-20230610185438046](images\image-20230610185438046.png)

**查询器选举机制**

IGMPv2使用独立的查询器选举机制，当共享网段上存在多个组播设备时，IP地址最小的设备成为查询器。

![image-20230610185508685](images\image-20230610185508685.png)

在IGMPv2中，查询器的选举过程如下：

1. 初始状态下，所有运行IGMPv2的组播设备（DeviceA和DeviceB）都认为自己是查询器，向本网段内的所有主机和组播设备发送普遍组查询报文。DeviceA和DeviceB在收到对方发送的普遍组查询报文后，将报文的源IP地址与自己的接口地址作比较。通过比较，IP地址最小的组播设备将成为查询器，其他组播设备成为非查询器。DeviceA的接口地址小于DeviceB，则DeviceA当选为查询器，DeviceB为非查询器。

2. 确定查询器后，将由IGMP查询器（DeviceA）向本网段内的所有主机和其他组播设备发送普遍组查询报文，而非查询器（DeviceB）则不再发送普遍组查询报文。

   非查询器（DeviceB）上都会启动一个定时器（即其他查询器存在时间定时器Other Querier Present Timer）。在该定时器超时前，如果收到了来自查询器的查询报文，则重置该定时器；否则，就认为原查询器失效，并发起新的查询器选举过程。

**离开组机制**

在IGMPv2中，成员离开组播组时可以主动向查询器发送离开报文，宣告自己离开了某个组播组。

![image-20230610185556659](images\image-20230610185556659.png)

主机HostA离开组播组G1的过程如下：

1. HostA向本地网段内的所有组播设备（目的地址为224.0.0.2）发送针对组G1的离开报文。
2. 查询器收到离开报文，会发送针对组G1的特定组查询报文。发送间隔和发送次数可以通过命令配置，缺省情况下每隔1秒发送一次，共发送两次。同时查询器启动组成员关系定时器（Timer-Membership=发送间隔x发送次数）。
3. 如果该网段内还存在组G1的其他成员（如HostB），这些成员在收到查询器发送的特定组查询报文后，会立即发送针对组G1的报告报文。查询器收到针对组G1的报告报文后将继续维护该组成员关系。如果该网段内不存在组G1的其他成员，查询器将不会收到针对组G1的报告报文。在Timer-Membership超时后，查询器将删除（*，G1）对应的IGMP组表项。当有组G1的组播数据到达查询器时，查询器将不会向下游转发。

## IGMPv3介绍

IGMPv3主要是为了配合SSM（Source-Specific Multicast）模型发展起来的，提供了在报文中携带组播源信息的能力，即主机可以对组播源进行选择。

## IGMPv3报文

与IGMPv2相比，IGMPv3报文的变化如下：

- IGMPv3报文包含两大类：查询报文和成员报告报文。IGMPv3没有定义专门的成员离开报文，成员离开通过特定类型的报告报文来传达。
- 查询报文中不仅包含普遍组查询报文和特定组查询报文，还新增了特定源组查询报文（Group-and-Source-Specific Query）。该报文由查询器向共享网段内特定组播组成员发送，用于查询该组成员是否愿意接收特定源发送的数据。特定源组查询通过在报文中携带一个或多个组播源地址来达到这一目的。
- 成员报告报文不仅包含主机想要加入的组播组，而且包含主机想要接收来自哪些组播源的数据。IGMPv3增加了针对组播源的过滤模式（INCLUDE/EXCLUDE），将组播组与源列表之间的对应关系简单的表示为（G，INCLUDE，(S1、S2...)），表示只接收来自指定组播源S1、S2……发往组G的数据；或（G，EXCLUDE，(S1、S2...)），表示接收除了组播源S1、S2……之外的组播源发给组G的数据。当组播组与组播源列表的对应关系发生了变化，IGMPv3报告报文会将该关系变化存放于组记录（Group Record）字段，发送给IGMP查询器。
- 在IGMPv3中一个成员报告报文可以携带多个组播组信息，而之前的版本一个成员报告只能携带一个组播组。这样在IGMPv3中报文数量大大减少。

![image-20230610185703851](images\image-20230610185703851.png)

| 字段              | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| Type              | 报文类型，取值为0x11。                                       |
| Max Response Code | 最大响应时间。成员主机在收到IGMP查询器发送的普遍组查询报文后，需要在最大响应时间内做出回应。 |
| Checksum          | 校验和。                                                     |
| Group Address     | 组播组地址。在普遍组查询报文中，该字段设为0；在特定组查询报文和特定源组查询报文中，该字段为要查询的组播组地址。 |
| Resv              | 保留字段。发送报文时该字段设为0；接收报文时，对该字段不做处理。 |
| S                 | 该比特位为1时，所有收到此查询报文的其他设备不启动定时器刷新过程，但是此查询报文并不抑制查询器选举过程和设备的主机侧处理过程。 |
| QRV               | 如果该字段非0，则表示查询器的健壮系数（Robustness Variable）。如果该字段为0，则表示查询器的健壮系数大于7。设备接收到查询报文时，如果发现该字段非0，则将自己的健壮系数调整为该字段的值；如果发现该字段为0，则不做处理。 |
| QQIC              | IGMP查询器的查询间隔，单位为秒。非查询器收到查询报文时，如果发现该字段非0，则将自己的查询间隔参数调整为该字段的值；如果发现该字段为0，则不做处理。 |
| Number of Sources | 报文中包含的组播源的数量。对于普遍组查询报文和特定组查询报文，该字段为0；对于特定源组查询报文，该字段非0。此参数的大小受到所在网络MTU大小的限制。 |
| Source Address    | 组播源地址，其数量受到Number of Sources字段值大小的限制。    |

IGMPv3成员报告报文格式

![image-20230610185756994](images\image-20230610185756994.png)

| 字段                        | 说明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| Type                        | 报文类型，取值为0x22。                                       |
| Reserved                    | 保留字段。发送报文时该字段设为0；接收报文时，对该字段不做处理。 |
| Checksum                    | IGMP报文的校验和。校验和是IGMP报文长度（即IP报文的整个有效负载）的16位检测，表示IGMP信息补码之和的补码。Checksum字段在进行校验计算时设为0。当发送报文时，必须计算校验和并插入到Checksum字段中去。当接收报文时，校验和必须在处理该报文之前进行检验。 |
| Number of Group Records (M) | 报文中包含的组记录的数量。                                   |
| Group Record                | 组记录。                                                     |

Group Record字段说明

| 字段                  | 说明                                                         |
| --------------------- | ------------------------------------------------------------ |
| Record Type           | 组记录的类型。共分为三大类。当前状态报告。用于对查询报文进行响应，通告自己目前的状态，共两种：MODE_IS_INCLUDE，表示接收源地址列表包含的源发往该组的组播数据。如果指定源地址列表为空，该报文无效。MODE_IS_EXCLUDE，表示不接收源地址列表包含的源发往该组的组播数据。过滤模式改变报告。当组和源的关系在INCLUDE和EXCLUDE之间切换时，会通告过滤模式发生变化，共两种：CHANGE_TO_INCLUDE_MODE，表示过滤模式由EXCLUDE转换到INCLUDE，接收源地址列表包含的新组播源发往该组播组的数据。如果指定源地址列表为空，主机将离开组播组。CHANGE_TO_EXCLUDE_MODE，表示过滤模式由INCLUDE转换到EXCLUDE，拒绝源地址列表包含的新组播源发往该组的组播数据。源列表改变报告。当指定源发生改变时，会通告源列表发生变化，共两种：ALLOW_NEW_SOURCES，表示在现有的基础上，需要接收源地址列表包含的组播源发往该组播组的组播数据。如果当前对应关系为INCLUDE，则向现有源列表中添加这些组播源；如果当前对应关系为EXCLUDE，则从现有阻塞源列表中删除这些组播源。BLOCK_OLD_SOURCES，表示在现有的基础上，不再接收源地址列表包含的组播源发往该组播组的组播数据。如果当前对应关系为INCLUDE，则从现有源列表中删除这些组播源；如果当前对应关系为EXCLUDE，则向现有源列表中添加这些组播源。 |
| Aux Data Len          | 辅助数据长度。在IGMPv3的报告报文中，不存在辅助数据字段，该字段设为0。 |
| Number of Sources (N) | 本记录中包含的源地址数量。                                   |
| Multicast Address     | 组播组地址。                                                 |
| Source Address        | 组播源地址。                                                 |
| Auxiliary Data        | 辅助数据。预留给IGMP后续扩展或后续版本。在IGMPv3的报告报文中，不存在辅助数据 |

## IGMPv3工作机制

在工作机制上，与IGMPv2相比，IGMPv3增加了主机对组播源的选择能力。

**特定源组加入**

IGMPv3的成员报告报文的目的地址为224.0.0.22（表示同一网段所有使能IGMPv3的设备）。通过在报告报文中携带组记录，主机在加入组播组的同时，能够明确要求接收或不接收特定组播源发出的组播数据。网络中存在S1和S2两个组播源，均向组播组G发送组播数据，Host仅希望接收从组播源S1发往组播组G的信息。

![image-20230610190418240](images\image-20230610190418240.png)

如果Host和组播设备之间运行的是IGMPv1或IGMPv2，Host加入组播组G时无法对组播源进行选择，无论其是否需要，都会同时接收到来自组播源S1和S2的数据。如果采用IGMPv3，成员主机可以发送IGMPv3报告（G，INCLUDE，(S1)），选择仅接收源S1向组播组G发送的数据。

**特定源组查询**

当接收到组成员发送的改变组播组与源列表的对应关系的报告时（比如CHANGE_TO_INCLUDE_MODE、CHANGE_TO_EXCLUDE_MODE），IGMP查询器会发送特定源组查询报文。如果组成员希望接收其中任意一个源的组播数据，将反馈报告报文。IGMP查询器根据反馈的组成员报告更新该组对应的源列表。

 IGMP三个版本的比较

| 项目               | IGMPv1                       | IGMPv2                       | IGMPv3                                                       |
| ------------------ | ---------------------------- | ---------------------------- | ------------------------------------------------------------ |
| 查询器选举方式     | 依靠组播路由协议PIM选举      | 同网段组播设备之间竞争选举   | 同网段组播设备之间竞争选举                                   |
| 普遍组查询报文     | 支持                         | 支持                         | 支持                                                         |
| 成员报告报文       | 支持                         | 支持                         | 支持                                                         |
| 特定组查询报文     | 不支持                       | 支持                         | 支持                                                         |
| 成员离开报文       | 不支持                       | 支持                         | 没有定义专门的成员离开报文，成员离开通过特定类型的报告报文来传达 |
| 特定源组查询报文   | 不支持                       | 不支持                       | 支持                                                         |
| 指定组播源         | 不支持                       | 不支持                       | 支持                                                         |
| 可识别报文协议版本 | IGMPv1                       | IGMPv1、IGMPv2               | IGMPv1、IGMPv2、IGMPv3                                       |
| ASM模型            | 支持                         | 支持                         | 支持                                                         |
| SSM模型            | 需要IGMP SSM Mapping技术支持 | 需要IGMP SSM Mapping技术支持 | 支持                                                         |

配置IGMP

#### 背景信息

IGMP功能只能配置在已经使能了PIM-SM的设备上，因为在使能IGMP前，一定要先配置**pim sm**，才能保证接口正常转发组播数据。



#### 操作步骤

1. 进入系统视图。

   ```
   system-view
   ```

2. 使能组播功能。

   ```
   multicast routing-enable
   ```

3. 进入与用户网段相连的接口视图。

   ```
   interface interface-type interface-number
   ```

4. 配置接口从二层模式切换到三层模式。

   ```
   undo portswitch
   ```

   请根据当前接口模式自行选择是否要执行此步骤。

5. 使能PIM-SM。

   ```
   pim sm 
   ```

   缺省情况下，接口上未使能PIM-SM。

   使用命令**undo pim sm**将会清除接口上的PIM邻居以及协议状态，启动IGMP功能后，请谨慎使用命令**undo pim sm**，否则会造成组播业务无法正常运行。

6. 使能IGMP。

   ```
   igmp enable
   ```

7. （可选）配置接口的IGMP版本。

   ```
   igmp version VersionValue 
   ```

   如果在主机侧共享网段上有多个组播设备，为了防止因组播设备上配置的IGMP协议版本不同而导致的IGMP功能无法正常运行，必须在所有组播设备与组成员相连的接口上配置相同的IGMP版本。






# 四 PIM简介

PIM（Protocol Independent Multicast，协议无关组播）是域内组播路由协议，利用单播路由信息，对组播消息进行RPF检查，创建组播路由表项。为IP组播提供路由信息的协议可以是任何单播路由协议，比如静态路由、RIP、OSPF、IS-IS、BGP等。组播路由和单播路由协议无关，只是通过单播路由表产生相应组播路由表项。

目前在实际网络中，PIM协议有三种模式：PIM-DM、使用ASM（Any-Source Multicast）模型的PIM-SM，使用SSM（Source-Specific Multicast）模型的PIM-SM。需要注意的是，同一个PIM域中不能同时运行PIM-DM和PIM-SM。

| 协议    | 名称                                                         | 模型分类 | 适用场景                                                     |
| ------- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ |
| PIM-DM  | Protocol Independent Multicast-Dense Mode协议无关组播—密集模式 | ASM模型  | 适合规模较小、组播组成员相对比较密集的网络。                 |
| PIM-SM  | Protocol Independent Multicast-Sparse Mode协议无关组播—稀疏模式 | ASM模型  | 适合网络中的组成员相对比较稀疏，分布广泛的大型网络。         |
| PIM-SSM | Protocol Independent Multicast-Source-Specific Multicast协议无关组播—指定源组播 | SSM模型  | 适合网络中的用户预先知道组播源的位置，直接向指定的组播源请求组播数据的场景。 |

## PIM设备

在接口上使能了PIM协议的设备即为PIM设备。PIM设备又分为以下几种：

- 叶子设备：与用户主机相连的PIM设备，但连接的用户主机不一定为组成员
- 第一跳设备：组播转发路径上，与组播源相连且负责转发该组播源发出的组播数据的PIM设备
- 最后一跳设备：组播转发路径上，与组播组成员相连且负责向该组成员转发组播数据的PIM设备
- 中间设备：组播转发路径上，第一跳设备与最后一跳设备之间的PIM设备

![image-20230610192241644](images\image-20230610192241644.png)

## PIM路由表项

PIM路由表收录所有PIM路由表项，并下发到组播转发表中，由转发表项直接指导组播消息转发。PIM协议中存在两种转发表项：(S, G)和(*, G)。S表示组播源，G表示组播组，*表示任意组播源。

- (S, G) 只适用于源地址为S，组地址为G的组播消息。
- (*, G) 适用于任意组播源，组地址为G的组播消息。

PIM设备收到源地址为S，组地址为G的组播消息，且通过RPF检查的情况下，按照如下的规则转发：

- 如果存在(S, G) 表项，则由(S, G) 表项指导消息转发。
- 如果不存在(S, G) 表项，则先依照(*, G) 表项创建(S, G) 表项，再由(S, G) 表项指导消息转发。

PIM路由表项中用于指导转发的内容包括：组播源地址、组播组地址、上游接口、上游邻居和下游接口列表。组播消息从唯一的上游接口到达，从一个或多个下游接口发送出去。

## 组播分发树

PIM网络以组播组为单位在设备上建立一点到多点的组播转发路径。由于组播转发路径呈现树型结构，也称为组播分发树MDT（Multicast Distribution Tree）。

组播分发树主要包括以下两种：

- SPT（Shortest Path Tree）：以组播源为根，组播组成员为叶子的组播分发树。SPT同时适用于PIM-DM网络和PIM-SM网络。。
- RPT（RP Tree）：以RP（Rendezvous Point）为根，组播组成员为叶子的组播分发树。RPT适用于PIM-SM网络。

## 组播分发树

PIM网络以组播组为单位在设备上建立一点到多点的组播转发路径。由于组播转发路径呈现树型结构，也称为组播分发树MDT（Multicast Distribution Tree）。

组播分发树主要包括以下两种：

- SPT（Shortest Path Tree）：以组播源为根，组播组成员为叶子的组播分发树。SPT同时适用于PIM-DM网络和PIM-SM网络。

  如[图5-1](https://support.huawei.com/enterprise/zh/doc/EDOC1100278275/21447011#fig_dc_vrp_multicast_cfg_000401)中的DeviceE→DeviceD→DeviceB、DeviceA，就是一棵以Source为根，以HostA、HostB为叶子的SPT。

- RPT（RP Tree）：以RP（Rendezvous Point）为根，组播组成员为叶子的组播分发树。RPT适用于PIM-SM网络。

## PIM的控制消息

PIM控制消息使用IP报文封装

![image-20230610192703336](D:\study\studyDoc\网工\images\image-20230610192703336.png)

IP报文头的协议类型字段值为103，用来标识数据部分封装了PIM消息。

IP报文头的目的地址字段用来标识该PIM消息的目的接收者。可以是单播地址，也可以是组播地址。

### PIM控制消息类型

![image-20230610192740423](images\image-20230610192740423.png)

PIM消息中以可编码的格式封装单播地址及组播地址，如组地址采用Encoded-Group format，源地址采用Encoded-Source format，BSR地址采用Encoded-Unicast format等。根据支持不同的协议类型，可编码封装的地址的长度是可变的。



| 字段     | 长度   | 说明                                               |
| -------- | ------ | -------------------------------------------------- |
| Version  | 4比特  | PIM版本，值为2。                                   |
| Type     | 4比特  | 消息类型                                           |
| Reserved | 8比特  | 保留字段，发送时此字段被清零，接收时不处理此字段。 |
| Checksum | 16比特 | 校验和。                                           |

#### Hello消息

PIM设备从所有PIM接口周期性的向外发送Hello消息。PIM设备之间通过交互Hello消息，发现PIM邻居并维护邻居关系。

封装Hello消息的IP报文源地址为本地接口地址，目的地址为224.0.0.13，TTL值为1。使用组播方式发送，

![image-20230610192915629](images\image-20230610192915629.png)

| 字段          | 长度     | 说明                   |
| ------------- | -------- | ---------------------- |
| Type          | 4比特    | 消息类型，值为0。      |
| Option Type   | 2字节    | 参数类型。             |
| Option Length | 2字节    | Option Value字段长度。 |
| Option Value  | 可变长度 | 参数值。               |

Option Type有效取值

| Option Type | Option Value                                                 |
| ----------- | ------------------------------------------------------------ |
| 1           | Holdtime，表示保持邻居为可达状态的超时时间，若超时仍没有收到Hello消息则认为邻居不可达。 |
| 2           | 该字段由三部分组成：LAN Prune Delay：在共享网段上传递Prune消息的延迟时间。Override Interval：在共享网段上执行剪枝前的否决时间。T：Join消息抑制能力位。 |
| 19          | DR Priority，表示各设备接口竞选DR（Designated Router）的优先级，优先级越高越容易获胜。 |
| 20          | Generation ID，Hello消息中携带的随机数，表示当前邻居状态。如果状态发生更新则随机数也会更新。当设备发现接收到的来自上游的Hello消息中包含不同Generation ID值，则认为上游邻居已经丢失或上游邻居状态已经改变。 |
| 21          | State Refresh Capable，表示邻居状态刷新时间间隔。            |
| 24          | Address List，PIM接口的从地址列表。                          |

#### Register消息

当PIM-SM网络中出现活跃组播源时，源端DR向RP（Rendezvous Point）发送Register消息，进行源注册。

封装Register消息的IP报文源地址为源端DR，目的地址为RP。使用单播方式发送。

![image-20230610193058684](images\image-20230610193058684.png)

egister消息字段说明

| 字段                  | 长度   | 说明                                                         |
| --------------------- | ------ | ------------------------------------------------------------ |
| Type                  | 4比特  | 消息类型，值为1。                                            |
| B                     | 1比特  | 边界位。                                                     |
| N                     | 1比特  | 空注册位。                                                   |
| Reserved2             | 30比特 | 保留字段，发送时此字段被清零，接收时不处理此字段。           |
| Multicast data packet | 变长   | 组播数据报文。源端DR将接收到的组播数据报文封装在Register消息中发往RP。RP解封装后，学习到该组播数据报文的(S, G)信息。 |

一个组播源可能同时向多个组播组发送数据，则源端DR必须向每个组播组对应的RP发送Register消息。一个Register消息只能封装一个组播数据报文，所以只能携带一项(S, G)信息。

在注册抑制期间，DR向RP发送“空注册消息”，通告组播源仍处于激活状态；注册抑制超时后，DR重新使用Register注册消息封装组播数据报文。在“空注册消息”中，Multicast data packet字段只包含组播数据报文的IP头（组播源地址和组地址等）。

#### Register-Stop消息

在PIM-SM网络中，在以下三种情况下，RP将会向组播源端DR发送Register-Stop消息。

- 接收者不再通过RP接收发往某组播组的数据
- RP不再为某组播组服务
- 组播数据转发路径已经由RPT切换到SPT

组播源端DR收到Register-Stop消息后，停止使用Register注册消息封装组播数据报文，并进入注册抑制状态。

封装Register-Stop消息的IP报文源地址为RP，目的地址为源端DR。使用单播方式发送

![image-20230610193148672](images\image-20230610193148672.png)

| 字段                                     | 长度  | 说明              |
| ---------------------------------------- | ----- | ----------------- |
| Type                                     | 4比特 | 消息类型，值为2。 |
| Group Address（Encoded-Group format）    | 变长  | 组播组地址G。     |
| Source Address（Encoded-Unicast format） | 变长  | 组播源地址S。     |

一个RP可能同时为多个组播组服务，而一个组播组可能同时对应多个向其发送数据的组播源。因此，一个RP上可能同时进行着多项(S, G)注册。

一个Register-Stop消息中只能携带一项(S, G)信息。当RP向源端DR发送一个Register-Stop消息，只能结束一项(S, G)注册。

源端DR收到携带(S, G)信息的Register-Stop消息后，只停止(S, G)报文的封装。源S向其他组播组发出的报文仍然使用Register消息封装。

#### Join/Prune消息

一条Join/Prune消息中可以同时包含Join信息和Prune信息。只包含Join信息的Join/Prune消息称为Join消息。只包含Prune信息的Join/Prune消息称为Prune消息。

- 当PIM设备下游没有组播需求时，从上游接口发出Prune消息，通知上游停止向该网段转发组播报文。
- 当PIM-SM网络中出现组成员时，组成员端DR从朝向RP的RPF接口，发出Join消息，通知上游邻居向该网段转发组播报文。Join消息逐跳向上，构建RPT。
- 当RP触发SPT切换时，RP从朝向组播源的RPF接口，发送Join消息，通知上游邻居向该网段转发组播报文。Join消息逐跳向上，构建RP-源树。
- 当组成员端DR触发SPT切换时，组成员端DR从朝向组播源的RPF（Reverse Path Forwarding）接口，发送Join消息，通知上游邻居向该网段转发组播报文。Join消息逐跳向上，构建SPT。
- PIM共享网段中可能同时连接着一个下游接口和多个上游接口。假设某上游接口发出Prune消息。如果其他上游接口仍然需要接收组播报文，则必须在“剪枝否决时间”内发出Join消息，那么该网段上负责转发的下游接口才不执行剪枝操作。在组播网络中，用户侧设备接口如果使能了PIM功能，则由PIM DR决定Join消息的发送。因为只有PIM DR才会添加出接口，只有添加出接口的设备才会发送Join消息。

DeviceA的Port 1接口是一个下游接口，DeviceB的Port 2接口和DeviceC的Port 3接口都是上游接口。如果DeviceB从Port 2接口发起Prune消息，DeviceC的Port 3接口和DeviceA的Port 1接口都会收到该消息，此时，如果DeviceC还想接收组播数据，那么就必须在剪枝否决时间（override-interval）内发送一个Join消息，这样DeviceA的Port 1接口才知道下游还有需要组播数据的设备，不执行剪枝操作。

![image-20230610193301642](images\image-20230610193301642.png)

封装Join/Prune消息的IP报文源地址为本地接口地址，目的地址为224.0.0.13，TTL值为1。使用组播方式发送，

 Join/Prune消息格式

![image-20230610193339944](images\image-20230610193339944.png)

 Join/Prune消息字段说明

| 字段                                                | 长度   | 说明                                                         |
| --------------------------------------------------- | ------ | ------------------------------------------------------------ |
| Type                                                | 4比特  | 消息类型，值为3。                                            |
| Upstream Neighbor Address（Encoded-Unicast format） | 变长   | 上游邻居地址。也就是收到Join/Prune消息的设备上，进行Join或Prune操作的下游接口地址。 |
| Reserved                                            | 8比特  | 保留位。                                                     |
| Number of Groups(N)                                 | 8比特  | 消息中包含的组播组数目。                                     |
| Holdtime                                            | 16比特 | 接收Join/Prune消息的设备保持相应接口加入/剪枝状态的时间。    |
| Group Address（Encoded-Group format）               | 变长   | 组播组地址。                                                 |
| Number of Joined Sources                            | 16比特 | 针对该组播组，请求加入的组播源总数。                         |
| Number of Pruned Sources                            | 16比特 | 针对该组播组，请求剪枝的组播源总数。                         |
| Joined Source Address（Encoded-Source format）      | 变长   | 请求加入的组播源地址。                                       |
| Pruned Source Address （Encoded-Source format）     | 变长   | 请求剪枝的组播源地址。                                       |

#### Bootstrap消息

当PIM-SM网络中使用动态RP时，配置了C-BSR（Candidate-BootStrap Router）的设备从所有PIM接口周期性的发送Bootstrap消息，参与BSR竞选。竞选获胜者，继续发送Bootstrap消息，向域内所有PIM设备发布RP-Set信息。

封装Bootstrap消息的IP报文源地址为PIM接口地址，目的地址为224.0.0.13，使用组播方式发送。TTL为1，在PIM-SM网络中逐跳转发，最终达到全网泛滥。

![image-20230610193440407](images\image-20230610193440407.png)

#### Assert消息

在共享网段上，如果PIM设备从(S, G)或(*, G)表项的下游接口收到(S, G)报文，则表示该网段存在其他的转发者。设备从该下游接口发出Assert消息，参与竞选。竞选落败者停止下游接口的转发。

封装Assert消息的IP报文源地址为本地接口地址，目的地址为224.0.0.13，TTL值为1。使用组播方式发送。

![image-20230610193512475](images\image-20230610193512475.png)

#### Graft消息

在PIM-DM网络中，设备上出现组成员时，如果本身不在SPT上，则从对应的(S, G)表项的上游接口发送Graft消息。上游邻居立即恢复下游接口的转发。如果上游邻居不在SPT上，则继续向上游发送Graft消息。

封装Graft消息的IP报文源地址为上游接口地址，目的地址为RPF邻居，使用单播方式发送。

#### Graft-Ack消息

在PIM-DM网络中，设备收到下游发来的Graft消息后，恢复相应下游的转发。同时从该下游接口发出Graft-Ack消息，表示已经接收嫁接请求。如果发出Graft消息的设备在一个设定时间内没有收到Graft-Ack消息，则认为上游未收到Graft消息，重发Graft消息。

封装Graft-Ack消息的IP报文源地址为上游设备的下游接口地址，目的地址为Graft消息的发出者，使用单播方式发送。

#### Ad

#### vertisement消息

当PIM-SM网络中使用动态RP时，配置了C-RP的设备周期性的向BSR发送Advertisement消息，通告希望服务的组范围。

封装Advertisement消息的IP报文源地址为C-RP，目的地址为BSR。使用单播方式发送

#### State-Refresh消息

在PIM-DM网络中，为了避免被剪枝的接口因为“剪枝定时器”超时而恢复转发，离组播源最近的第一跳设备会周期性地触发State-Refresh消息。State-Refresh消息在全网扩散，刷新所有设备上的剪枝定时器状态。

封装State-Refresh消息的IP报文源地址为下游接口地址，目的地址为224.0.0.13，TTL值为1，使用组播方式发送。

# 五 PIM-DM

PIM-DM主要采用扩散-剪枝的方式转发组播数据，即PIM-DM首先将组播数据扩散到各个网段，然后再裁剪掉不存在组成员的网段。通过周期性的“扩散—剪枝”，构建并维护一棵连接组播源和组成员的单向无环SPT，最终实现组播数据的转发。由于对组播组成员稀疏的网络会产生大量Prune消息而对规模较大的网络扩散-剪枝周期会很长，所以PIM-DM适合规模较小、组播组成员相对比较密集的网络。

![image-20230611083029002](images\image-20230611083029002.png)

PIM-DM域中组播数据转发的实现过程是：

1. 邻居发现（Neighbor Discovery）：在PIM-DM域中，PIM设备通过周期性的向所有其他PIM设备发送[Hello消息](https://support.huawei.com/enterprise/zh/doc/EDOC1100278275?section=j026)，来发现PIM邻居，维护PIM设备之间的PIM邻居关系。缺省情况下，无论PIM设备是否收到来自邻居的Hello消息，都会接收其他的PIM控制消息或组播报文。但是如果PIM设备配置了邻居检查功能，则只有在PIM设备接收到来自邻居的Hello消息后，才会接收其他的PIM控制消息或组播报文。
2. 扩散（Flooding）：PIM-DM假设网络中的每个子网都存在至少一个组播组成员，因此组播数据将被扩散到网络中的所有节点，网络中所有的PIM设备都能接收到组播数据。
3. 剪枝（Prune）：组播数据扩散到网络中后，PIM-DM对没有组播数据接收者的分支进行剪枝，只保留包含接收者的分支，即确保网络中只有需要组播数据的PIM设备能够接收到组播数据，不需要组播数据的PIM设备接收不到组播数据。
4. 状态刷新（State-Refresh）：如果设备处于剪枝状态，其上游PIM设备会维护一个“剪枝定时器”。当剪枝定时器超时，上游PIM设备恢复对不需要数据的下游PIM设备的数据转发，这样会导致不必要的网络资源浪费。采用状态刷新可使离组播源最近的第一跳设备周期性发送[State-Refresh消息](https://support.huawei.com/enterprise/zh/doc/EDOC1100278275?section=j026)，刷新所有设备的剪枝定时器状态，对不需要数据的下游设备始终保持剪枝状态。
5. 嫁接]（Graft）：当被剪枝分支的节点上出现了组播组成员时，为了减少该节点恢复成转发状态所需的时间，PIM-DM使用嫁接机制主动恢复其对组播数据的转发。
6. 断言（Assert）：如果在一个网段内出现多台PIM设备，则相同的组播报文可能会被重复发送到该网段。通过[断言](https://support.huawei.com/enterprise/zh/doc/EDOC1100278275/512e849e#section_dc_vrp_multicast_feature_311109)可以为网段选定唯一的组播数据转发者，避免冗余的组播数据转发。



## 邻居发现

PIM设备在每个使能了PIM的接口上，都会对外发送Hello消息。封装Hello消息的组播报文有如下特点：

- 目的地址是224.0.0.13，表示同一网段中所有PIM设备
- 源地址为接口的IP地址
- TTL数值为1，仅发送给邻居接口

Hello消息具有发现邻居、协商各项协议参数、维持邻居关系的作用

**发现PIM邻居**

同一网段中的PIM设备都必须接收目的地址为224.0.0.13的组播报文。这样在收到Hello消息以后，直接相连的组播设备之间，就可以知道自己的邻居信息。

**协商各项协议参数**

Hello消息中携带多项协议参数，邻居之间通过Hello消息来进行协商，这些参数包括：

- DR_Priority：表示各设备接口竞选DR的优先级，优先级越高越容易获胜。
- Holdtime：表示保持邻居为可达状态的超时时间。
- LAN_Delay：表示共享网段内传输Prune消息的延迟时间。
- Override-Interval：表示Hello消息中携带的否决剪枝的时间间隔。

## **维持邻居关系**

PIM设备之间周期性地发送Hello消息。如果Holdtime超时还没有收到该PIM邻居发出的新的Hello消息，则认为该邻居不可达，将其从邻居列表中清除。

PIM邻居的变化将导致网络中组播拓扑的变化。如果组播分发树上的某上游邻居或下游邻居不可达，将导致组播路由重新收敛，组播分发树迁移。

## 扩散

组播数据源（Source）把数据发送到DeviceA，DeviceA把数据报文发送给所有的邻居。这时DeviceB与DeviceC也会相互转发数据报文，但PIM-DM协议采用RPF（Reverse Path Forwarding）检查机制可以保证数据只从一个方向接收。（关于RPF检查请参见RPF单播逆向路由检查。）最后数据被扩散到连接接收者的DeviceB和没有连接接收者的DeviceC。以上的过程称之为扩散。

![image-20230611084327183](images\image-20230611084327183.png)

## 剪枝

由于DeviceC没有接收者，不需要数据，则向上游DeviceA发送Prune消息，通知DeviceA不必再向该下游网段转发数据。DeviceA收到Prune消息后，停止向该下游接口转发，以上的过程称之为剪枝。

由于DeviceA上还存在其他处于转发状态的下游接口，因此DeviceA向DeviceB转发组播数据。后续到达的组播数据只向DeviceB转发，从而实现了一棵连接组播源和组成员Receiver的单向无环最短路径树。

![image-20230611084529173](images\image-20230611084529173.png)

## 状态刷新

DeviceA对DeviceC所在网段处于剪枝状态，那么DeviceA对DeviceC的接口会维护一个“剪枝定时器”，当剪枝定时器超时，DeviceA就会恢复对不需要数据的DeviceC的数据转发，这样会导致不必要的网络资源浪费。

PIM-DM协议采用状态刷新特性解决此问题。离组播源最近的第一跳DeviceA周期性触发State-Refresh消息。State-Refresh消息在全网扩散，刷新所有设备上的剪枝定时器状态，对不需要数据的下游设备始终保持剪枝状态。

![image-20230611084610601](images\image-20230611084610601.png)

状态刷新过程如下：

1. DeviceA触发状态刷新，将State Refresh报文向DeviceB和DeviceC扩散。
2. DeviceA上存在被裁剪接口，刷新该接口的“剪枝定时器”的状态。下一次“扩散-剪枝”来临时，由于DeviceC上仍然没有组成员加入，DeviceA上被裁剪的接口将被抑制转发组播报文。

## 嫁接

如果之前处于剪枝状态的DeviceC收到接收者HostB的IGMP Report报文，请求转发组播源数据。为了避免扩散-剪枝的周期长，导致新出现的组成员不能快速得到组播数据，PIM-DM用嫁接方式实现数据的快速转发。

DeviceC发送Graft消息，请求上游DeviceA恢复对应出接口的转发。DeviceA收到Graft消息后，将连接DeviceC的出接口恢复转发，组播数据报文由该下游接口到达DeviceC。



## 断言

在组播网络中，如果出现如下情况，则说明网段上还存在着其他的组播转发者。

- 该组播报文不能通过RPF检查。
- 接收到该组播报文的接口是本设备上(S, G)表项中的一个下游接口。

此时，设备会执行Assert机制。设备从该下游接口发送Assert消息。同时，该下游接口也接收到了来自该网段上其他组播转发者的Assert消息。Assert消息的目的地址为224.0.0.13，源地址为下游接口地址，TTL为1。Assert消息中携带该PIM设备到组播源或RP的开销、所采用的单播路由协议的优先级和组播组地址G。

设备将自身条件与对方报文中携带的信息进行比较，称为Assert竞选。规则如下：

1. 单播路由协议优先级较高者获胜。
2. 如果优先级相同，则到组播源或RP的开销较小者获胜。
3. 如果以上都相同，则下游接口IP地址最大者获胜。

根据Assert竞选结果，设备将执行不同的操作：

- 如果获胜，则该下游接口保持转发状态，设备负责后续在该网段上的(S, G)转发，该下游接口称为Assert winner。
- 如果落败，则禁止该下游接口转发组播报文，将其从(S, G)表项下游接口列表中删除。该下游接口称为Assert loser。

Assert竞选结束后，该网段上只存在一个有下游接口的上游设备，只传输一份组播报文。Assert winner周期性发送Assert消息，维持Assert winner的状态。若Assert loser的定时器超时后，Assert loser仍没有收到Assert winner的[Asser消息，则重新添加下游接口转发组播数据。

如果DeviceB和DeviceC都能够接收到组播源Source发出的组播报文，并且均能通过RPF检查，创建(S, G)表项。DeviceB、DeviceC的下游接口连接在同一网段，那么DeviceB和DeviceC就会同时向该网段发送组播数据。Assert机制可以保证一个网段只能存在一个组播数据转发者。Assert过程如下：

1. DeviceB从下游接口接收到DeviceC发来的组播报文，RPF检查失败，报文被丢弃。同时，DeviceB向该网段发送Assert消息
2. DeviceC将自身的路由信息与对方的Assert消息中携带的路由信息进行比较，由于自身到组播源的开销较大而落败。于是禁止该下游接口转发组播报文，将其从DeviceC的(S, G)表项的下游接口列表中删除。
3. DeviceC从该网段接收到DeviceB发来的组播报文，RPF检查失败，报文被丢弃。Assert过程结束。

![image-20230611084836468](images\image-20230611084836468.png)

## 配置PIM-DM基本功能

1. 进入系统视图。

   ```
   system-view
   ```

2. 使能公网实例IP组播路由。

   ```
   multicast routing-enable
   ```

3. 进入接口视图。

   ```
   interface interface-type interface-number
   ```

4. 配置接口从二层模式切换到三层模式。

   ```
   undo portswitch
   ```

   请根据当前接口模式自行选择是否要执行此步骤。

   

5. 使能PIM-DM。

   ```
   pim dm
   ```

   

   缺省情况下，接口上未使能PIM-DM。

## 检查配置结果

- 执行命令**display pim** **neighbor** [ **interface** *interface-type* *interface-number* | *neighbor-address* | **verbose** ] *，查看PIM邻居信息。
- 执行命令**display pim grafts**，查看未确认的PIM-DM嫁接信息。
- 执行命令**display pim** [ **vpn-instance** *vpn-instance-name* | **all-instance** ] **control-message** **counters** [ **interface** *interface-type interface-number* | **message-type** { **assert** | **hello** | **join-prune** | **graft** | **graft-ack** | **state-refresh** | **bsr** | **discovery** } ] *，查看发送和接收PIM控制报文的数目信息。
- 执行命令**display pim routing-table** [ *group-address* [ **mask** { *group-mask-length* | *group-mask* } ] | *source-address* [ **mask** { *source-mask-length* | *source-mask* } ] | **incoming-interface** *interface-type* *interface-number* | **outgoing-interface** { **include** | **exclude** | **match** } *interface-type* *interface-number* | **flags** *flag-value* | **fsm** ] * [ **outgoing-interface-number** [ *number* ] ]，查看PIM路由表项信息。

# 六 ASM模型的PIM-SM

PIM-SM（Protocol Independent Multicast-Sparse Mode，协议无关组播-稀疏模式）可以有效解决大型网络且用户分布比较分散的场景中点到多点的数据传输问题，使用户能够按需接收数据。

PIM-SM假设网络中所有主机均不需要接收组播数据，只有在主机明确提出需要接收组播数据时，才会构建组播分发树，向提出需求的主机转发组播数据。

![image-20230614212724773](images\image-20230614212724773.png)



- PIM域：由PIM设备所组成的网络称为PIM网络。通过在组播设备接口上设置BSR边界，可以限制BSR消息的传播，从而划分PIM-SM域。将一个大的PIM网络划分成多个PIM域，可以实现组播业务之间的隔离，便于管理网络。
- DR：DR（Designated Router）称为指定设备，在PIM网络中，存在两种DR：
  - 组播源DR：在PIM-SM中，组播源DR是与组播源直接相连且负责向RP发送注册报文的PIM设备。
  - 接收者DR：与组播组成员（通常为接收者主机）直接相连且负责向该组成员转发组播数据的PIM设备。
- RP：RP（Rendezvous Point）称为汇聚点，它是PIM-SM网络的转发核心。接收者DR向RP发起加入，构建以RP为根的RPT；组播源DR向RP发送注册报文，在RP上创建(S, G)表项，通过RP向组成员传输组播报文。网络中的设备必须知道RP的地址

| RP类型 | 实现机制                                                     | 使用场景                                                     | 注意事项                                                     |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 静态RP | 用户可在网络中的所有PIM设备上手工配置相同的地址为静态RP地址，网络中的所有PIM设备都以此地址作为RP地址。 | 对于中小型网络，建议选择静态RP方式，对设备要求低，也比较稳定。如果网络中只有一个组播源，建议选择直连组播源的设备作为静态RP，这样可以省略组播源DR向RP注册的过程。 | 采用静态RP方式要确保域内所有设备（包括RP本身）的RP信息以及服务的组播组范围全网一致。 |
| 动态RP | 在PIM域内将几台PIM设备配置为C-RP（Candidate-RP），即候选RP。在这些C-RP中，通过竞选产生RP，BSR通过Bootstrap消息将当前网络中的所有C-RP信息汇总为RP-Set，发布给所有的PIM设备。网络中的所有PIM设备根据RP-Set，使用相同的规则进行计算和比较，从多个C-RP中竞选出RP。由于所有PIM设备使用相同的RP-Set和相同的竞选规则，即：它们具有相同的RP信息。一旦竞选出的RP出现故障，剩余C-RP会重新进行选举，产生新的RP。 | 对于大型网络，可以采用动态RP，可靠性高，可维护性强。如果网络中存在多个组播源，且分布密集，建议选择与组播源比较近的核心设备作为C-RP。如果网络中存在多个用户，且分布密集，建议选择与用户比较近的核心设备作为C-RP。 | 如果使用动态RP，则必须同时配置BSR。通过BSR，组播网络中的设备可以动态地掌握组播组到RP的映射。 |

- **BSR**：BSR（Bootstrap Router）称为自举设备，负责在PIM-SM网络启动后，收集网络内的RP信息，然后将RP集（即组-RP映射数据库）发布到整个PIM-SM网络。一个网络内部只能有一个BSR，但是可以配置多个候选BSR，即C-BSR（Candidate-Bootstrap Router）。一旦BSR出现故障，剩余C-BSR中会重新选举出BSR。
- **RPT**：RPT（Rendezvous Point Tree），称为共享树。以RP（Rendezvous Point）为根，组播组成员为叶子的组播分发树称为RPT。
- **SPT**：SPT（Shortest Path Tree），称为最短路径树。以组播源为根，组播组成员为叶子的组播分发树称为SPT。

## 实现过程

PIM-SM域中组播数据转发的实现过程是：

1. 邻居发现（Neighbor Discovery）：在PIM-SM域中，PIM设备通过周期性的向所有PIM设备发送Hello消息，来发现PIM邻居，维护PIM设备之间的PIM邻居关系。缺省情况下，无论PIM设备是否收到来自邻居的Hello消息，都会接收其他的PIM控制消息或组播报文。但是如果PIM设备配置了邻居检查功能，则只有在PIM设备接收到来自邻居的Hello消息后，才会接收其他的PIM控制消息或组播报文。
2. DR竞选（DR Election）：PIM设备之间交互Hello消息为共享网络选举DR，接收者DR将作为该共享网络中组播数据的唯一转发者，组播源DR负责将组播源的数据发送给RP。
3. RP发现（RP Discovery）：RP是PIM-SM域中的核心设备。通过配置静态或动态RP，依靠此RP为整个网络转发组播数据。
4. RPT建立（RPT Setup）：PIM-SM假设所有主机都不需要接收组播数据，只向明确提出需要组播数据的主机转发。实现组播转发的核心任务就是构建并维护RPT，组播数据通过RP沿RPT转发给接收者。
5. SPT切换（SPT Switchover）：在PIM-SM域中，一个组播组唯一对应一个RP和RPT，RP是所有组播数据必经的中转站。但由RP转发组播数据的转发路径不一定是从组播源到接收者的最短路径，且当组播流量变大时，RP负担增大，因此，当组播数据的转发速率超过阈值时，可进行SPT切换，直接在组播源与接收者间建立最优路径，缓解RP的负担。

如果网络中出现了异常情况，可以通过断言和DR切换延迟来保证组播数据的正常传输：

- 断言（Assert）：如果在一个网段内出现多台PIM设备，则相同的组播报文可能会被重复发送到该网段。可通过断言为网段选定唯一的组播数据转发者，避免冗余的组播数据的转发。
- DR切换延迟（DR Switchover Delay）：当网络中的某接口由DR变为非DR时，PIM设备会立即停止使用此接口转发数据。如果此时新DR的组播数据还未到达，那么将会出现短暂的组播数据断流。配置DR切换延迟后，该接口在延迟时间超时前仍然继续转发组播数据，避免组播数据断流的情况。

## DR竞选

在组播源或组成员所在的网段，通常同时连接着多台PIM设备。这些PIM设备之间通过交互Hello消息成为PIM邻居，Hello消息中携带DR优先级和该网段接口地址。设备将自身情况与对方报文中携带的信息进行比较，称为DR竞选。规则如下：

- DR优先级较高者获胜（网段中所有设备都支持DR优先级）。
- 如果DR优先级相同或该网段存在不支持在Hello消息中携带DR优先级的设备，则IP地址较大者获胜。

## RP发现

RP（Rendezvous Point）称为汇聚点，它是PIM-SM网络的转发核心。RP为静态RP和动态RP：

- 静态RP：静态RP通过配置命令在网络中的所有设备上配置相同的RP地址来指定，无需进行竞选。
- 动态RP：如果配置动态RP，则需要在PIM设备间竞选产生。

使用动态RP，必须同时配置C-BSR（Candidate-Bootstrap Router），由C-BSR竞选产生BSR。

![image-20230614213303443](images\image-20230614213303443.png)

## RP发现

RP（Rendezvous Point）称为汇聚点，它是PIM-SM网络的转发核心。RP为静态RP和动态RP：

- 静态RP：静态RP通过配置命令在网络中的所有设备上配置相同的RP地址来指定，无需进行竞选。
- 动态RP：如果配置动态RP，则需要在PIM设备间竞选产生。

动态RP的竞选规则如下：

1. 最初，每个C-BSR都认为自己是BSR，向全网发送Bootstrap消息。Bootstrap消息中携带C-BSR地址、C-BSR的优先级。每一台设备都收到所有C-BSR发出的Bootstrap消息，通过比较这些C-BSR信息，竞选产生BSR。由于所有设备使用相同的竞选规则，所以得到的获胜BSR也相同。网络中的所有设备都知道BSR的地址。竞选规则如下：
   1. 优先级较高者获胜（优先级数值越大优先级越高）。
   2. 如果优先级相同，IP地址较大者获胜。
2. C-RP向BSR发送Advertisement消息，消息中携带C-RP地址、服务的组范围和C-RP优先级等。
3. BSR将这些信息汇总为RP-Set，封装在Bootstrap消息中，发布给全网的每一台PIM-SM设备。
4. 各设备根据RP-Set，使用相同的规则进行计算和比较，从多个针对特定组的C-RP中竞选出该组RP。规则如下：
   1. 与用户加入的组地址匹配的C-RP服务的组范围掩码最长者获胜。
   2. 如果与用户加入的组地址匹配的C-RP服务的组范围掩码长度相同，则比较C-RP优先级，C-RP优先级较高者获胜（优先级数值越大优先级越低）。
   3. 如果优先级相同，则执行Hash函数，计算结果较大者获胜。
   4. 如果以上都相同，则C-RP地址较大者获胜。
5. 由于所有设备使用相同的RP-Set和竞选规则，所以得到的“组播组-RP”对应关系也相同。设备将“组播组-RP”对应关系保存下来，指导后续的组播操作。

如果设备需要与支持Auto-RP的设备互通，可以使能Auto-RP侦听功能。使能后，设备可以接收Auto-RP宣告和发现报文，并解析报文的源地址，根据源地址进行RPF检查。

- 如果RPF检查失败，则设备丢弃该Auto-RP报文。
- 如果RPF检查通过，则设备向其他PIM邻居转发Auto-RP报文，此报文中携带RP服务的组地址范围，指导后续的组播操作。

![image-20230614214055671](images\image-20230614214055671.png)

## SPT切换

在PIM-SM网络中，一个组播组只对应一个RP，只构建一棵RPT。在未进行SPT切换的情况下，所有发往该组的组播报文都必须先封装在Register消息中发往RP，RP解封装后，再沿RPT分发。

由于所有通过RPT转发的组播数据报文必须经过RP中转，所以当组播数据报文逐渐增多时，会对RP形成巨大的负担。为了解决此问题，PIM-SM允许由RP或接收者DR触发SPT切换，建立一条从数据源直接到接收者的转发链路，组播源可以沿SPT将组播数据转发到接收者。

![image-20230614214155348](images\image-20230614214155348.png)

SPT切换的两种方式如下:

- RP触发SPT切换：RP收到源端DR的Register消息后，将封装在Register消息中的组播数据沿RPT转发给组成员，同时RP会向源端DR发送SPT Join消息，建立RP到源的SPT。SPT建立成功后，当RP从SPT接收到第一个组播数据报文后，RP停止使用Register消息，使源端DR和RP免除了频繁的封装/解封装。组播数据从与组播源直接相连的设备，通过SPT树转发到RP，再沿RPT转发给组成员。
- 组成员端DR触发SPT切换，具体流程如下：
  1. 组播数据由RPT转发，组播数据沿组播源DR(DeviceA)->RP(DeviceB)->接收者DR(DeviceD)到达接收者（Receiver）。
  2. 接收者DR周期性检测组播报文的转发速率。一旦发现(S, G)报文的转发速率超过阈值，则触发SPT切换。
  3. 接收者DR直接向组播源端DR发送(S，G) Join消)，当接收者DR收到沿SPT发来的组播数据后，丢弃沿RPT发来的组播数据，同时向RP发送[Prune消息](https://support.huawei.com/enterprise/zh/doc/EDOC1100278275?section=j026)，删除RPT中的此接收者，实现从RPT向SPT的切换。
  4. 组播数据由SPT转发，组播数据沿组播源DR(DeviceA)->接收者DR(DeviceD)到达接收者（Receiver）。

建立从源到组成员的SPT后，后续报文可能不再流经RP。由于RPT不一定是路径最短的树，进行SPT切换后，减少了组播数据在网络中的传输延迟。

网络中可能存在一个组播源向多个组播组发送组播报文。若指定了针对某个组播组范围的SPT切换策略：

- SPT切换前，这些报文都沿RPT到达组成员端DR。
- 完成SPT切换后，只有组播源发往属于SPT切换策略中组播组范围内的组播组的报文沿SPT转发，而组播源发往其他组播组的报文，仍会沿RPT转发。



# 七 IGMP Snooping配置

IGMP Snooping（Internet Group Management Protocol Snooping，互联网组管理协议窥探）是二层组播的基本功能，主要用于在二层设备上优化组播流量的转发行为，可以实现组播数据在二层设备上转发和控制。

当二层设备DeviceB未部署IGMP Snooping，以太网二层设备DeviceB通过interface10连接到组播设备DeviceA，同时它还连接着一些用户。在这些用户中，UserA和UserB是某组播组的成员，它们将会向网络中发送IGMP成员关系报告，宣告自己加组。此后如果DeviceA收到发往该组播组的流量，会将这些流量转发到该交换网络，那么组成员UserA和UserB都会收到所需的组播流量。但是，缺省情况下，当二层设备DeviceB在某个VLAN内收到的目的MAC地址未知的单播帧、组播帧或广播帧时，它都会将这些数据帧在相同的VLAN内进行泛洪，因此二层设备DeviceB会将发往该组播组的流量从自己的interface1、interface2、interface3等接口都转发出去（假设都属于同一VLAN）。此时即使有些用户（图中UserC）不是该组播组的成员，它们也将收到组播流量，造成了网络带宽和设备性能的浪费。

当二层设备DeviceB部署了IGMP Snooping之后，当组成员UserA和UserB通过IGMP成员关系报告报文宣告自己加组时，DeviceB除了将这些报文发给组播设备DeviceA，还会解析报文中的内容，将报文中的组播组地址与接口interface1、interface2等信息进行绑定，从而创建二层转发表项。此后，当DeviceB收到组播设备DeviceA发送的组播流量后，会根据二层转发表中的表项将流量从interface1、interface2接口转发出去，此时非组播成员UserC将不会收到这些组播流量。因此，部署IGMP Snooping之后，DeviceB只会将组播流量从正确的接口转发出去。

- 如果DeviceB没有运行IGMP Snooping，组播数据在数据链路层被广播。
- 如果DeviceB运行了IGMP Snooping，如果某些用户不需要接收组播组的组播数据，组播数据就不会在数据链路层被广播，而会通过二层组播转发表从相应的端口interface1和interface2发给需要的接收者。

![image-20230617193620735](images\image-20230617193620735.png)

IGMP Snooping实现了组播数据在数据链路层按需转发，具有以下价值：

- 节省网络带宽
- 保护组播数据安全
- 减少上游三层设备性能压力
- 保证用户服务质量

## IGMP Snooping基本概念

三层设备Router从组播源接收数据并向下游转发，在二层组播设备DeviceA和DeviceB上分别运行IGMP Snooping，HostA、HostB和HostC为接收者主机（即组播组成员）。

![image-20230617193659265](images\image-20230617193659265.png)

 IGMP Snooping中的端口角色

| 端口角色                                                     | 作用                                   | 如何生成                                                     |
| ------------------------------------------------------------ | -------------------------------------- | ------------------------------------------------------------ |
| 路由器端口（Router Port）是指二层组播设备上朝向三层组播设备（DR或IGMP查询器）一侧的接口，如DeviceA和DeviceB上蓝色圆圈表示的接口。**说明：**路由器端口都是指二层组播设备上朝向组播路由器的接口，而不是指路由器上的接口。 | 二层组播设备从此接口接收组播数据报文。 | 由协议生成的路由器端口叫做动态路由器端口。收到源地址不为0.0.0.0的IGMP普遍组查询报文或PIM Hello报文（三层组播设备的PIM接口向外发送的用于发现并维持邻居关系的报文）的接口都将被视为动态路由器端口。手工配置的路由器端口叫做静态路由器端口。 |
| 成员端口（Member Port）又称组播组成员端口，表示二层组播设备上朝向组播组成员一侧的端口，如DeviceA和DeviceB上绿色方框表示的接口。 | 二层组播设备往此接口发送组播数据报文。 | 由协议生成的成员端口叫做动态成员端口。收到IGMP Report报文的接口，二层组播设备会将其标识为动态成员端口。手工配置的成员端口叫做静态成员端口。 |

层组播转发表项是组播设备转发组播数据的依据，组播设备可以根据此表项将来自上游的组播数据报文转发给接收者主机

二层组播转发表项内容

| 项目       | 描述                       |
| ---------- | -------------------------- |
| VLAN编号   | 用于指定二层广播域的范围。 |
| 组播组地址 | 组播IP地址。               |
| 路由器端口 | 当前设备的上游接口。       |
| 成员端口   | 当前设备的下游接口。       |

## IGMP Snooping工作原理

DeviceA是最后一跳的组播路由器，其连接二层设备DeviceB的接口已经激活了IGMP（以IGMPv2为例）。DeviceB已经部署了IGMP Snooping，DeviceB的所有接口已加入了VLAN10。初始时，DeviceB的二层组播转发表是空的，此时即使收到DeviceA转发的组播流量，也不会将流量转发到任何接口。

![image-20230617193806518](images\image-20230617193806518.png)

1. DeviceA的接口激活IGMP后，开始周期性地发送IGMP常规查询报文。

2. DeviceB将在其interface10接口收到DeviceA发送的IGMP常规查询报文，由于此时DeviceB的IGMP Snooping路由器接口列表为空，因此它将interface10添加到该列表中，也就是将这个接口指定为动态路由器接口，同时为该接口启动一个老化计时器。此后如果DeviceB再次在该接口上收到IGMP常规查询报文，则刷新这个计时器。然后，DeviceB将该IGMP常规查询报文从VLAN10中、除了interface10接口之外的所有接口泛洪出去。



![image-20230617200756305](images\image-20230617200756305.png)

3. UserA，UserB，UserC都将收到DeviceB泛洪的IGMP常规查询报文。由于UserC并非任何组播组成员，因此它只是简单地丢弃该报文，不会做任何回应。而UserA和UserB是组播239.1.1.22的成员，因此它们各自发送IGMP成员关系报告报文。

![image-20230617200842135](images\image-20230617200842135.png)

4. 接下来DeviceB将在自己的interface1和interface2接口上收到IGMP成员关系报告报文，由于激活了IGMP Snooping，因此DeviceB将解析其所收到的IGMP成员关系报告报文。它解析到interface1和interface2接口所连接的用户需要加入组播组239.1.1.22，于是它在自己的二层组播转发表中创建239.1.1.22表项，将interface1和interface2接口指定为该表项的动态成员接口，并分别为这两个接口启动老化计时器。此后DeviceB如果再次在这两个接口上收到IGMP成员关系报告报文，则刷新该计时器。紧接着，DeviceB将其收到的IGMP成员关系报告报文从路由器接口interface10转发出去。
5. DeviceA收到DeviceB转发上来的IGMP成员关系报告报文后，它将维护相关的组播表项，并在收到发往239.1.1.22的组播流量后向DeviceB进行转发。而DeviceB在接口interface10上收到发往239.1.1.22的组播流量后，首先查询自己的二层组播转发表项，发现存在匹配的表项，而且该表项中存在interface1和interface2这两个成员接口，因此它将组播流量从这两个接口转发出去，该组播成员的UserC则不会收到这些组播流量。
6. 当UserA要离开组播组239.1.1.22，它向网络发送一个IGMP离组报文。DeviceB将在其interface1接口上收到这个报文。DeviceB通过查询自己的二层组播转发表后发现，该接口是组播组239.1.1.22的成员接口，因此它将这个报文从所有的路由器接口（也就是interface10）转发出去。
7. DeviceA收到UserA发送的IGMP离组报文后，立即发送IGMP特定组查询报文。
8. DeviceB将在其interface10接口上收到这个IGMP特定组查询报文，它将这个报文从除了interface10接口之外的、VLAN10中的所有接口转发出去。
9. UserB收到这个IGMP特定组查询报文后，发现查询器所查询的正是自己所在的组播组，于是它立即回应IGMP成员关系报告报文。
10. DeviceB将在其interface2上收到这个IGMP成员关系报告报文，它查询自己的二层组播转发表项后发现，interface2接口已经是组播239.1.1.22的成员接口，因此它刷新改接口老化计时器，然后将IGMP成员关系报告从路由器接口interface10转发出去。
11. DeviceA收到UserB发的IGMP成员关系报告后，意识到网段中还存在组播组239.1.1.22的组成员，因此继续向该网段转发239.1.1.22的组播流量。
12. 由于UserA已经离开组播组239.1.1.22，因此它不再发送IGMP成员关系报告报文。一段时间后，成员接口interface1的老化计时器将会超时，于是DeviceB将其从组播组239.1.1.22的成员接口列表中删除。至此，DeviceB不再向interface1接口转发该组播组的流量。

IGMP Snooping对不同报文的处理方式

| IGMP工作阶段                                                 | 二层组播设备收到的报文类型               | 处理方式                                                     |
| ------------------------------------------------------------ | ---------------------------------------- | ------------------------------------------------------------ |
| 普遍组查询IGMP查询器定期向本地网段内的所有主机与路由器（目的地址为224.0.0.1）发送IGMP普遍组查询报文，以查询该网段有哪些组播组的成员。 | IGMP普遍组查询报文                       | 向VLAN内除接收接口外的其他所有接口转发，并对接收接口做如下处理：如果路由器端口列表中尚未包含该接口，则将其添加进去，并启动老化定时器。如果路由器端口列表中已包含该路由器端口，则重置老化定时器。**说明：**收到IGMP普遍组查询报文时，动态路由器端口的老化定时器缺省为180秒，可以通过命令行配置。 |
| 成员报告有两种情况：成员收到IGMP普遍组查询报文后，回应IGMP报告报文。成员主动向IGMP查询器发送IGMP报告报文以声明加入该组播组。 | IGMP报告报文                             | 向VLAN内所有路由器端口转发。从报文中解析出主机要加入的组播组地址，并对接收接口做如下处理：如果不存在该组对应的转发表项，则创建转发表项，将该接口作为动态成员端口添加到出接口列表中，并启动老化定时器。如果已存在该组对应的转发表项，但出接口列表中未包含该接口，则将该接口作为动态成员端口添加到出接口列表，并启动老化定时器。如果已存在该组所对应的转发表项，且出接口列表中已包含该动态成员端口，则重置其老化定时器。**说明：**收到IGMP报告报文后，动态成员端口的老化定时器 = 健壮系数 x 普遍组查询间隔 + 最大响应时间。 |
| 成员离开组播组有两个阶段：运行IGMPv2或IGMPv3的成员发送IGMP离开报文，以通知IGMP查询器自己离开了某个组播组。IGMP查询器收到IGMP离开报文后，从中解析出组播组地址，并通过接收接口向该组播组发送IGMP特定组查询报文/IGMP特定源组查询报文。 | IGMP离开报文                             | 判断离开的组是否存在对应的转发表项，以及转发表项出接口列表是否包含报文的接收接口：如果不存在该组对应的转发表项，或者该组对应转发表项的出接口列表中不包含接收接口，二层组播设备不转发该报文，将其直接丢弃。如果存在该组对应的转发表项，且转发表项的出接口列表中包含该接口，二层组播设备会将报文向VLAN内所有路由器端口转发。对于IGMP离开报文的接收接口（假定为动态成员端口），二层组播设备在其老化时间内：如果从该接口收到了主机响应IGMP特定组/源组查询的报告报文，表示接口下还有该组的成员，于是重置其老化定时器。如果没有从该接口收到主机响应IGMP特定组/源组查询的报告报文，则表示接口下已没有该组成员，则在老化时间超时后，将接口从该组的转发表项出接口列表中删除。**说明：**收到IGMP离开报文后，动态成员端口的老化定时器 = 健壮系数 x 特定组查询间隔。 |
| IGMP特定组查询报文/IGMP特定源组查询报文                      | 向VLAN内除接收接口外的其他所有接口转发。 |                                                              |

## 使能IGMP Snooping功能

IGMP Snooping基本功能是实现二层组播的前提，包括使能IGMP Snooping、IGMP Snooping可以处理的IGMP报文的版本和IGMP Snooping转发模式。

使能IGMP Snooping后，主机发往三层设备的IGMP Report消息经过二层设备时，二层设备对IGMP Report消息进行侦听并记录下来，为端口和组播组地址建立起映射关系；当二层设备收到组播数据时，根据这样的映射关系，只向连有组成员的端口转发组播数据。

#### 操作步骤

1. 进入系统视图。

   ```
   system-view
   ```

2. 使能全局IGMP Snooping功能。

   ```
   igmp snooping enable
   ```

   缺省情况下，IGMP Snooping功能处于未使能状态。

3. 进入VLAN视图。

   ```
   vlan vlan-id
   ```

4. 使能VLAN的IGMP Snooping功能。

   ```
   igmp snooping enable
   ```

# 八 华为PIM-SM 动态RP实验配置



![image-20230618090822583](C:\Users\cs1\AppData\Roaming\Typora\typora-user-images\image-20230618090822583.png)



## 启动pim

```bash
multicast routing-enable   开启组播路由转发功能
int g0/0/0
 pim sm                 开启PIM SM（所有接口都要开启）
int g0/0/1
 pim sm
int g4/0/0
 pim sm
```

R8 R9 R10

```
multicast routing-enable
int g0/0/0
 pim sm
int g0/0/1
 pim sm
```

![image-20230618090949908](images\image-20230618090949908.png)



## 配置DR



```
此处场景可以不配置DR优先级操作，因为此处组播源和组成员所在网段只连接着一个PIM路由器，不需要进行DR选举，此PIM路由器就为DR
当存在多个PIN路由器时就需要选举，通过配置DR优先级来改变DR的选举结果
AR6
interface GigabitEthernet0/0/0
 pim hello-option dr-priority 100   配置PIM接口的DR优先级（0~4294967295）
 数值越大，优先级越高（缺省为1，DR优先级相同时，IP地址大优先）
interface GigabitEthernet4/0/0
 pim hello-option dr-priority 40
AR10
interface GigabitEthernet0/0/1
 pim hello-option dr-priority 100
```

## 配置动态RP

```
默认静态RP优先级低于动态RP，当配置静态RP是加入 preferred字段，则静态优于动态
配置C-BSR（AR9会选为BSR，AR8为C-BSR）
AR9上配置
Int loop 0
 pim sm
pim
 c-bsr LoopBack0 hash-length 1 priority 100
 配置c-bsr为Loop0接口，C-BSR的哈希掩码长度为1-缺30，优先级为10-缺0
 C-BSR的优先级用于选举BSR，数值越大，优先级越高
 C-BSR哈希掩码长度用于RP竞选
AR8上配置
int loop 0
 pim sm
pim
 c-bsr LoopBack0 hash-length 1 priority 10
```

```
AR9上配置
acl number 2001     
 rule 5 permit source 239.0.0.1 0.0.0.0
 rule deny
pim
 c-rp LoopBack0 group-policy 2001 priority 10
 配置路由器向BSR通告自己为C-RP，自己的组范围为ACL 2001内允许的组播组
 配置自己的RP优先级为10，数值越大，优先级越低，缺0

AR8上配置
acl number 2001
 rule 5 permit source 239.0.0.10 0.0.0.0
 rule deny
pim
 c-rp LoopBack0 group-policy 2001

```

![image-20230618091512027](images\image-20230618091512027.png)

## 组成员端DR上配置IGMP

```
interface GigabitEthernet0/0/1
 igmp enable
 igmp version 2
 如果要配置SSM模型时，使用的IGMP等级为IGMP v3
```

![image-20230618092845111](images\image-20230618092845111.png)

![image-20230618092919588](images\image-20230618092919588.png)