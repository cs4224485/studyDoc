## 一 IPV6协议

### 主要变化

- **更大的地址空间**：IPv6将IPv4的`32`比特地址空间增大到了`128`比特，在采用合理编址方法的情况下，在可预见的未来是不会用完的。
- **扩展的地址层次结构**：可划分为更多的层次，这样可以更好地反映出因特网的拓扑结构，使得对寻址和路由层次的**设计更具有灵活性**。
- **灵活的首部格式**：与IPv4首部并不兼容。IPv6定义了许多**可选的的扩展首部**，不仅可提供比IPv4更多的功能，而且还可以**提高路由器的处理效率**，因为路由器对逐跳扩展首部外的其他扩展首部都不进行处理。
- **改进的选项**：IPv6允许分组**包含有选项的控制信息**，因而**可以包含一些新的选项**。然而IPv4规定的选项却是固定不变的。
- **允许协议继续扩充**：这一点很重要，因为技术总是在不断地发展，而新的应用也会层出不穷。然而IPv4的功能却是固定不变的。
- **支持即插即用（即自动配置）**：IPv6支持主机或路由器自动配置IPv6地址及其他网络配置参数。因此**IPv6不需要使用DHCP**。
- **支持资源的预分配**：IPv6能为实时音视频等要求保证一定带宽和时延的应用，**提供更好的服务质量保证**。
- **最小的MTU**变为`1280`字节

### IPv6地址

IPv6 将实现 IPv6 的主机和路由器均称为**结点**。

一个结点就可能有多个与链路相连的**接口**。

- IPv6 地址是分配给结点上面的接口的。
- 每个IPv6接口都必须有至少一个本地链路单播地址，一个接口可以分配多个任意类型的地址。

### 表示方法

IPv6 地址是一个 `128` 位的二进制数。

![image-20231104103746807](images\image-20231104103746807.png)

在IPv6地址的冒号十六进制记法的基础上，再使用**“左侧零”省略和“连续零”压缩**，可使IPv6地址的表示更加**简洁**。

- “左侧零”省略是指两个冒号间的十六进制数中最前面的一串0**可以省略不写**。
- “连续零”压缩是指一连串连续的0可以用**一对冒号取代**。

![在这里插入图片描述](images\e4b6acad47b5448f87017dc3b5ef9230.png)

- 在一个IPv6地址中只能使用

  一次“连续零”压缩

  ，否则会导致歧义。

  冒号十六进制记法还可**结合点分十进制的后缀**。这在IPv4向IPv6过渡阶段非常有用。

![image-20231104103952236](images\image-20231104103952236.png)

### 地址分类

IPv6数据报的目的地址有三种基本类型：

- **单播地址** (unicast address)：传统的点对点通信。
- **多播地址** (multicast address)：一点对多点的通信。数据报发送到一组计算机中的每一个。IPv6没有采用广播的术语，而将**广播看作多播的一个特例**。
- **任播地址** (anycast address)：这是 IPv6 增加的一种类型。任播的目的站是**一组计算机**，但数据报在交付时只交付**离发送方最近（由路由协议度量）的一个计算机**。

[RFC 4291]对IPv6地址进行了分类：

- 未指明地址

  - 128个比特为“**全0**”的地址，可缩写为两个冒号“`::/128`”。
  - 该地址不能用作目的地址，只能用于**还没有**配置到一个标准IPv6地址的主机用作源地址。
  - 未指明地址**仅有一个**。

- 环回地址

  - **最低**比特为`1`，其余127个比特为“**全0**”，即`0:0:0:0:0:0:0:1`，可缩写为`::1/128`。
  - 该地址的作用与IPv4的环回地址**相同**。
  - IPv6的环回地址只有**一个**。

- **多播地址**

  （组播地址）

  - **最高**`8`比特为“**全1**”的地址，可记为`FF00::/8`。

![在这里插入图片描述](images\75f405307328489a9c2eb453eaa5f6a9.png)

- 标志位字段：最高位保留，设为`0`；`T`位为`1`表示是**熟知组播地址**；`T`位为`0`表示是**临时组播地址**；`P`标志表示组播地址的生成方式；`R`标志用于构成组播`RP`地址

   1 接口本地范围 2 链路本地范围 4 管理本地范围 5 站点本地范围 8 机构本地范围 E 全球范围 0 、 3 、 F 保留

![image-20231104110039337](images\image-20231104110039337.png)

**被请求节点组播地址**

被请求节点组播地址通过节点的单播或任播地址生成。一个节点具有了单播或任播地址，就会对应生成一个被请求节点组播地址，并且加入这个组播组。一个单播地址或任播地址对应一个被请求节点组播地址。该地址主要用于邻居发现机制和地址重复检测功能。IPv6中没有广播地址，也不使用ARP。但是仍然需要从IP地址解析到MAC地址的功能。在IPv6中，这个功能通过邻居请求NS（NeighborSolicitation）报文完成。当一个节点需要解析某个IPv6地址对应的MAC地址时，会发送NS报文，该报文的目的IP就是需要解析的IPv6地址对应的被请求节点组播地址；只有具有该组播地址的节点会检查处理。



**本地链路单播地址**

**最高**`10`比特为`1111111010`的地址，可记为`FE80::/10`。

![在这里插入图片描述](images\218127c6534048bfb4d5371da32d9e3d.png)

- 即使用户网络没有连接到因特网，但仍然可以使用TCP/IP协议。连接在这种网络上的主机都可以使用本地链路单播地址进行通信，但不能和因特网上的其他主机通信。
- 这类地址占IPv6地址空间的`1/1024`。

**全球单播地址**

- 全球单播地址是使用得**最多**的一类地址。
- IPv6全球单播地址采用**三级结构**，这是为了使路由器可以更快地查找路由。

![在这里插入图片描述](images\f21b5eea2e304531854df6ed3098acc8.png)

- **全球路由选择前缀**：分配给公司和机构，用于因特网中路由器的路由选择，相当于IPv4分类地址中的**网络号**。
- **子网标识符**：用于各公司和机构构建自己的子网。
- **接口标识符**：用于指明主机或路由器的单个网络接口，相当于IPv4分类地址中的**主机号**，**不需要使用ARP**。

**子网路由任播地址：**

- 一个任播地址可以被分配给一组接口，且通常这组接口属于不同节点
- 发往一个任播地址的分组会被路由协议转发给离发送方最近的接口
- **任播接口的地址结构无法与单播地址相区分**，包含在单播地址空间（包括本地链路单播地址和全球单播地址）中。
- 当一个单播地址分配给多个接口时，它就是一个任播地址
- 被分配了任播地址的一组主机往往分散在不同网络中，这些网络的最长共同前缀构成一个拓扑区域。

##  二 IPv6数据报的首部

###  基本首部

![在这里插入图片描述](images\400c059d5f8f4515bd894dc51a9094cf.png)

注意：所有的扩展首部并不属于IPv6数据报的首部，它们与其后面的数据部分合起来构成有效载荷（payload，也称为净负荷）。

Pv4 vs IPv6：

![在这里插入图片描述](images\8e770569c72845cb9069adc912e30787.png)

但由于IPv6地址的长度扩展到了128比特，因此使得IPv6数据报基本首部的长度**反而增大到了40字节**，比IPv4数据报首部固定部分的长度（20字节）**增大了20字节**。

- 取消了首部长度字段，因为IPv6数据报的首部长度是固定的`40`字节。
- 取消了区分服务（服务类型）字段，因为IPv6数据报首部中的**通信量类和流标号字段**实现了区分服务字段的功能。
- 取消了总长度字段，改用**有效载荷长度字段**。这是因为IPv6数据报的首部长度是固定的40字节，只有其后面的有效载荷长度是可变的。
- 取消了标识、标志和片偏移字段，因为这些功能已包含在IPv6数据报的**分片扩展首部**中。
- 把生存时间TTL字段改称为**跳数限制字段**，这样名称与作用更加一致。
- 取消了协议字段，改用**下一个首部**字段。
- 取消了首部检验和字段，这样可以加快路由器处理IPv6数据报的速度。
- 取消了选项字段，改用**扩展首部**来实现选项功能。

![在这里插入图片描述](images\cc0587c81ae04222b84a1405517e371a.png)

- **版本字段**：长度为`4`比特，用来表示IP协议的版本。对于IPv6该字段的值是`6`。
- **通信量类字段**（traffic class）：长度为`8`比特，该字段用来**区分不同的IPv6数据报的类别或优先级**。目前正在进行不同的通信量类性能的实验。
- **流标号字段**（flow label）：长度为`20`比特
- **有效载荷长度字段**（playload length）：长度为`16`比特，它指明IPv6数据报基本首部后面的**有效载荷（包括扩展首部和数据部分）的字节数量**。该字段以**字节**为单位，最大取值为`65535`，因此IPv6数据报基本首部后面的有效载荷的最大长度为65535字节。
- **下一个首部字段**：长度为`8`比特。该字段相当于IPv4数据报首部中的**协议字段或可选字段**。**当IPv6数据报没有扩展首部时**，该字段的作用与IPv4的协议字段一样，它的值指出了IPv6数据报基本首部后面的数据是何种协议数据单元PDU。若为`6`，则有效载荷部分是TCP报文段；若为`17`，则有效载荷部分是UDP用户数据报。
- **跳数限制字段**：长度为8比特。该字段用来**防止IPv6数据报在因特网中永久兜圈**。
- **源地址字段和目的地址字段**：长度都为`128`比特。分别用来填写IPv6数据报的发送端的IPv6地址和接收端的IPv6地址。

**当IPv6数据报基本首部后面带有扩展首部时**，该字段的值就标识后面第一个扩展首部的类型。

![在这里插入图片描述](images\111d5e10e10443a09294bb22d61120c7.png)

###  扩展首部

**IPv4数据报**如果在其首部中使用了**选项字段**，则在数据报的整个传送路径中的全部路由器，都要对选项字段进行检查，这就**降低了路由器处理数据报的速度**。

实际上，在路径中的路由器对很多选项是不需要检查的。因此，**为了提高路由器对数据包的处理效率**，IPv6把原来IPv4首部中的选项字段都放在了扩展首部中，由路径两端的源点和终点的主机来处理，而**数据报传送路径中的所有路由器都不处理这些扩展首部**（除逐跳选项扩展首部）。

在[RFC 2460]中定义了以下**六种扩展首部**：

| 扩展首部类型                                       | 扩展首部协议号 |
| -------------------------------------------------- | -------------- |
| 逐跳选项（Hop-by-Hop Options）                     | 0              |
| 路由选择（Routing）                                | 43             |
| 分片（Fragment）                                   | 44             |
| 目的选项（Destination Options）                    | 60             |
| 认证（Authentication）                             | 51             |
| 封装安全有效载荷（Encapsulating Security Payload） | 50             |
| 无下一扩展首部                                     | 59             |

- **每一个扩展首部都由若干个字段组成**，它们的长度也各不相同。
- **所有扩展首部中的第一个字段都是8比特的下一个首部字段**。该字段的值指出在该扩展首部后面是何种扩展首部。
- 当使用多个扩展首部时，**应按以上的先后顺序出现**。
- 扩展首部的长度应是`8`字节的整数倍，以此保证后续首部能在8字节边界处对齐。
- **逐跳选项**扩展首部和**目的选项**扩展首部的选项字段长度可变，可包含多个选项数据。这些选项数据以TLV方式（Type-Length-Value）编码.

### 逐跳选项

- 逐跳选项用于在分组中携带需要**被传输路径上所有节点处理**的信息
- 它必须是**第一个扩展首部**
- 下一首部字段（8位）：指明紧跟在逐跳选项扩展首部后的下一个首部类型
- 扩展首部长度字段（8位） ：以`8`字节位单位，**不包含第一个8字节**
- 选项数据字段：包含**多个**以TLV方式编码的选项

![image-20231104105401599](images\image-20231104105401599.png)

### 路由扩展选项

- 用于列出**分组传输过程中需要访问的节点地址**
- 路由类型（8位）：进一步区分路由扩展首部的类型，两种，0/2
- 剩余段数（8位）：指明路由地址列表尚未被访问的地址数
- 指定路由类型数据：依赖于具体的路由类型

![image-20231104105452010](images\image-20231104105452010.png)

### 分片扩展选项

- 路由器发现分组长度大于要转发网络的最大传输分组时，丢弃分组并向源主机发送ICMP分组超大信息，由源主机对IP分组进行分片
- 保留（8位）：置为`0`
- 片偏移（13位）：指明数据第一个字节对于原始未分片分组数据的偏移值，8字节为单位
- 保留（2位）：置为`0`
- M标志字段（1位）：`1`表示有更多分片，`0`表示是最后一个分片
- 标识符：每个未分片分组的唯一标识符，用于重组时区分分片属于的分组

![image-20231104105524459](images\image-20231104105524459.png)

## 三 从IPv4向IPv6过渡

因特网上使用IPv4的路由器的数量太大，要让所有路由器都改用IPv6并不能一蹴而就。因此，**从IPv4转变到IPv6只能采用逐步演进的办法**。

另外，**新部署的IPv6系统必须能够向后兼容**，也就是IPv6系统必须能够接收和转发IPv4数据报，并且能够为IPv4数据报选择路由。

下面介绍两种由IPv4向IPv6过渡的策略：

### 使用双协议栈

- 双协议栈（Dual Stack）是指在完全过渡到IPv6之前，使一部分主机或路由器**装有IPv4和IPv6两套协议栈**。
- 双协议栈主机或路由器**既可以和IPv6系统通信，又可以和IPv4系统通信**。
- 双协议栈主机或路由器记为IPv6/IPv4，表明它**具有一个IPv6地址和一个IPv4地址**

​       双协议栈主机在与IPv6主机通信时采用IPv6地址，而与IPv4主机通信时采用IPv4地址。

​       双协议栈主机在与IPv6主机通信时采用IPv6地址，而与IPv4主机通信时采用IPv4地址。

​       若DNS返回的是IPv4地址，则双协议栈的源主机就使用IPv4地址；

​       若DNS返回的是IPv6地址，则双协议栈的源主机就使用IPv6地址。

![image-20231104105704036](images\image-20231104105704036.png)

### 使用隧道技术

隧道技术（Tunneling）的核心思想是：

- 当IPv6数据报要进入IPv4网络时，**将IPv6数据报重新封装成IPv4数据报**，即整个IPv6数据报成为IPv4数据报的数据载荷。
- 封装有IPv6数据报的IPv4数据报在IPv4网络中传输。
- 当IPv4数据报要离开IPv4网络时，再将其数据载荷（即原来的IPv6数据报）取出并转发到IPv6网络。

![image-20231104105743285](images\image-20231104105743285.png)

## 四 ipv6 地址生成方式

目前IPv6地址的分配方法有以下几种：

（1）手动配置。手动配置IPv6地址/前缀及其他网络配置参数（DNS、NIS、SNTP服务器地址等参数）。

（2）无状态自动地址分配。由接口ID生成链路本地地址，再根据路由通告报文RA（Router Advertisement）包含的前缀信息自动配置本机地址

（3）有状态自动地址分配，即DHCPv6方式。DHCPv6又分为如下两种:

​	1 DHCPv6有状态自动分配：DHCPv6服务器自动分配IPv6地址/PD前缀及其他网络配置参数（DNS、NIS、SNTP服务器地址等参数）

​	2 DHCPv6无状态自动分配：主机IPv6地址仍然通过路由通告方式自动生成，DHCPv6服务器只分配除IPv6地址以外的配置参数，包括DNS、NIS、SNTP

### 无状态自动配置

IPv6无状态地址配置方式是目前广泛采用的IPv6地址自动配置方式。配置了该协议的主机只需相邻设备开启IPv6路由通告功能，即可以根据通告报文包含的前缀信息自动配置本机地址

无状态地址配置方案中设备并不记录所连接的IPv6主机的具体地址信息，可管理性差。而且当前无状态地址配置方式不能使IPv6主机获取DNS服务器的IPv6地址等配置信息，在可用性上有一定缺陷

### 有状态自动配置

与其他IPv6地址分配方式（手工配置、通过路由器通告消息中的网络前缀无状态自动配置等）相比，DHCPv6具有以下优点：

<1>更好地控制IPv6地址的分配。DHCPv6方式不仅可以记录为IPv6主机分配的地址，还可以为特定的IPv6主机分配特定的地址，以便于网络管理

<2>DHCPv6支持为网络设备分配IPv6前缀，便于全网络的自动配置和网络层次性管理。

<3>除了为IPv6主机分配IPv6地址/前缀外，还可以分配DNS服务器IPv6地址等网络配置参数

### DHCPv6有状态自动分配

![image-20231104110731387](images\image-20231104110731387.png)

#### DHCPv6四步交互地址分配过程如下：

​	1 DHCPv6客户端发送Solicit报文，请求DHCPv6服务器为其分配IPv6地址和网络配置参数。

​	2 如果Solicit报文中没有携带Rapid Commit选项，或Solicit报文中携带RapidCommit选项，但服务器不支持快速分配过程，则DHCPv6服务器回复Advertise报文，通知客户端可以为其分配的地址和网络配置参数。

​	3 如果DHCPv6客户端接收到多个服务器回复的Advertise报文，则根据Advertise报文中的服务器优先级等参数，选择优先级最高的一台服务器，并向所有的服务器发送Request组播报文，该报文中携带已选择的DHCPv6服务器的DUID。

​	4 DHCPv6服务器回复Reply报文，确认将地址和网络配置参数分配给客户端使用。

DHCPv6两步交互

两步交互常用于网络中只有一个DHCPv6服务器的情况。DHCPv6客户端首先通过组播发送Solicit报文来定位可以为其提供服务的DHCPv6服务器，DHCPv6服务器收到客户端的Solicit报文后，为其分配地址和配置信息，直接回应Reply报文，完成地址申请和分配过程。

两步交换可以提高DHCPv6过程的效率，但在有多个DHCPv6服务器的网络中，多个DHCPv6服务器都可以为DHCPv6客户端分配IPv6地址，回应Reply报文，但是客户端实际只可能使用其中一个服务器为其分配的IPv6地址和配置信息。

为了防止这种情况的发生，管理员可以配置DHCPv6服务器是否支持两步交互地址分配方式。DHCPv6服务器端如果配置使能了两步交互，并且客户端报文中也包含Rapid Commit选项，服务器采用两步交互方式为客户端分配地址和配置信息。如果DHCPv6服务器不支持快速分配地址，则采用四步交互方式为客户端分配IPv6地址和其他网络配置参数

#### DHCPv6两步交互地址分配过程如下：

1 DHCPv6客户端在发送的Solicit报文中携带Rapid Commit选项，标识客户端希望服务器能够快速为其分配地址和网络配置参数。

2 DHCPv6服务器接收到Solicit报文后，将进行如下处理：如果DHCPv6服务器支持快速分配地址，则直接返回Reply报文，为客户端分配IPv6地址和其他网络配置参数，Replay报文中也携带Rapid Commit选项。

3 如果DHCPv6服务器不支持快速分配过程，则采用四步交互方式为客户端分配IPv6地址/前缀和其他网络配置参数。

## 五 ICMPv6协议

由于IPv6与IPv4一样，都**不确保数据报的可靠交付**，因此IPv6也需要**使用**网际控制报文协议`ICMP`来向发送IPv6数据报的源主机**反馈一些差错信息**，相应的ICMP版本为`ICMPv6`。

ICMPv6比ICMPv4要复杂得多，它**合并了原来的地址解析协议ARP和网际组管理协议IGMP的功能**。因此与IPv6配套使用的网际层协议就只有ICMPv6这一个协议。

###  封装

ICMPv6的协议类型号（即IPv6报文中的Next Header字段的值）为58。

ICMPv6报文需要封装成IPv6数据报进行发送：

![在这里插入图片描述](images\95e33153eb144fb2b2cb3e20f9b3f21c.png)



![image-20231104111424288](images\image-20231104111424288.png)

报文中字段解释如下：

Type：表明消息的类型，0至127表示差错报文类型，128至255表示消息报文类型。

Code：表示此消息类型细分的类型。

Checksum：表示ICMPv6报文的校验和。

### ICMPv6错误报文的分类

ICMPv6错误报文用于报告在转发IPv6数据包过程中出现的错误。ICMPv6错误报文可以分为以下4种：

​	**1 目的不可达错误报文**，在IPv6节点转发IPv6报文过程中，当设备发现目的地址不可达时，就会向发送报文的源节点发送ICMPv6目的不可达错误报文，同时报文中会携带引起该错误报文的具体原因。目的不可达错误报文的Type字段值为1。根据错误具体原因又可以细分为：

​	Code=0：没有到达目标设备的路由。

​	Code=1：与目标设备的通信被管理策略禁止。

​	Code=2：未指定。

​	Code=3：目的IP地址不可达。

​	Code=4：目的端口不可达。

   **2 数据包过大错误报文**，在IPv6节点转发IPv6报文过程中，发现报文超过出接口的链路MTU时，则向发送报文的源节点发送ICMPv6数据包过大错误报文，其中携带出接口的链路MTU值。数据包过大错误报文是Path MTU发现机制的基础。数据包过大错误报文的Type字段值为2，Code字段值为0。

  **3 时间超时错误报文**，在IPv6报文收发过程中，当设备收到Hop Limit字段值等于0的数据包，或者当设备将Hop Limit字段值减为0时，会向发送报文的源节点发送ICMPv6超时错误报文。对于分段重组报文的操作，如果超过定时时间，也会产生一个ICMPv6超时报文。时间超时错误报文的Type字段值为3，根据错误具体原因又可以细分为：Code=0：在传输中超越了跳数限制。 Code=1：分片重组超时。

4 **参数错误报文**，当目的节点收到一个IPv6报文时，会对报文进行有效性检查，如果发现问题会向报文的源节点回应一个ICMPv6参数错误差错报文。参数错误报文的Type字段值为4，根据错误具体原因又可以细分为：

​	Code=0：IPv6基本头或扩展头的某个字段有错误。

​	Code=1：IPv6基本头或扩展头的NextHeader值不可识别。

​	Code=2：扩展头中出现未知的选项

### ICMPv6信息报文

ICMPv6信息报文提供诊断功能和附加的主机功能，比如多播侦听发现和邻居发现。常见的ICMPv6信息报文主要包括回送请求报文（EchoRequest）和回送应答报文（Echo Reply），这两种报文也就是通常使用的Ping报文。回送请求报文：回送请求报文用于发送到目标节点，以使目标节点立即发回一个回送应答报文。

 	回送请求报文的Type字段值为128，Code字段的值为0。

​	回送应答报文的Type字段的值为129，Code字段的值为0。

### IPv6 NDP

![image-20231104112005058](images\image-20231104112005058.png)

邻居发现协议NDP（Neighbor Discovery Protocol）是IPv6协议体系中一个重要的基础协议。邻居发现协议替代了IPv4的ARP（Address Resolution Protocol）和ICMP路由器发现（Router Discovery），它定义了使用ICMPv6报文实现地址解析，跟踪邻居状态，重复地址检测，路由器发现以及重定向等功能。

#### 地址解析：取代IPv4中的ARP

![image-20231104112103068](images\image-20231104112103068.png)

Host A在向Host B发送报文之前它必须要解析出Host B的链路层地址，所以首先Host A会发送一个NS报文，其中源地址为Host A的IPv6地址，目的地址为Host B的被请求节点组播地址，需要解析的目标IP为Host B的IPv6地址，这就表示Host A想要知道Host B的链路层地址。

同时需要指出的是，在NS报文的Options字段中还携带了Host A的链路层地址。当Host B接收到了NS报文之后，就会回应NA报文，其中源地址为Host B的IPv6地址，目的地址为Host A的IPv6地址（使用NS报文中的Host A的链路层地址进行单播），Host B的链路层地址被放在Options字段中。这样就完成了一个地址解析的过程

1. 当PC1想访问PC2时，会查找自己的ipv6 neighbor表
2. 如果ipv6 neighbor表里没有此邻居，则会以组播（使用PC2的ipv6地址计算出来的被请求节点组播地址为目标地址）的方式往外发送NS报文（携带有自己的mac地址）
3. 因为PC2是属于这个组的，所以PC2会处理这个NS报文，解析NS报文发现PC1要请求自己的MAC地址
4. PC2以单播的方式发送NA消息，携带了自己的MAC地址

#### 重复地址检测：探测是否有其它的节点使用了该地址

![image-20231104112327984](images\image-20231104112327984.png)

1. 当PC1配置一个IPv6地址时，不会立即生效，是一个试验地址。
2. PC1会使用一个源为：：目的地址为这个地址对应的被请求节点组播地址的NS消息（会携带target ip）进行重复地址检测
3. 如果网络中有人发送NA（目的地址为FF02：：1）响应这个NS消息，则认为这个地址已经有人使用，这个地址将不会生效
4. 如果在一段时间内没人响应这个NS消息，则认为这个地址是没有冲突的

#### 路由器发现

路由器发现功能用来发现与本地链路相连的设备，并获取与地址自动配置相关的前缀和其他配置参数。在IPv6中，IPv6地址可以支持无状态的自动配置，即主机通过某种机制获取网络前缀信息，然后主机自己生成地址的接口标识部分。

路由器发现功能是IPv6地址自动配置功能的基础，主要通过以下两种报文实现：

1. 路由器通告RA（Router Advertisement）报文：每台设备为了让二层网络上的主机和设备知道自己的存在，定时都会组播发送RA报文，RA报文中会带有网络前缀信息，及其他一些标志位信息。RA报文的Type字段值为134。
2. 路由器请求RS（Router Solicitation）报文：很多情况下主机接入网络后希望尽快获取网络前缀进行通信，此时主机可以立刻发送RS报文，网络上的设备将回应RA报文。RS报文的Tpye字段值为

![image-20231104112620066](images\image-20231104112620066.png)

#### 重定向

当网关设备发现报文从其它网关设备转发更好，它就会发送重定向报文告知报文的发送者，让报文发送者选择另一个网关设备

![image-20231104112707040](images\image-20231104112707040.png)

1.  Host A需要和Host B通信，Host A的默认网关设备是Router A，当Host A发送报文给Host B时报文会被送到Router A
2. Router A接收到Host A发送的报文以后会发现实际上Host A直接发送给Router B更好，它将发送一个重定向报文给主机A。其中报文中更好的路径下一跳地址为Router B，DestinationAddress为Host B
3. Host A接收到了重定向报文之后，会在默认路由表中添加一个主机路由，以后发往Host B的报文就直接发送给Router B注意：路由器收到重定向报文时，不会进行重定向

### Path MTU

在IPv4中，报文如果过大，必须要分片进行发送，所以在每个节点发送报文之前，设备都会根据发送接口的最大传输单元MTU（MaximumTransmission Unit）来对报文进行分片。

但是在IPv6中，为了减少中间转发设备的处理压力，中间转发设备不对IPv6报文进行分片，报文的分片将在源节点进行。当中间转发设备的接口收到一个报文后，如果发现报文长度比转发接口的MTU值大，则会将其丢弃；同时将转发接口的MTU值通过ICMPv6报文的“Packet Too Big”消息发给源端主机，源端主机以该值重新发送IPv6报文，这样带来了额外流量开销。PMTU发现协议可以动态发现整条传输路径上各链路的MTU值，减少由于重传带来的额外流量开销。

PMTU协议是通过ICMPv6的Packet Too Big报文来完成的。

首先源节点假设PMTU就是其出接口的MTU，发出一个试探性的报文，当转发路径上存在一个小于当前假设的PMTU时，转发设备就会向源节点发送Packet Too Big报文，并且携带自己的MTU值，此后源节点将PMTU的假设值更改为新收到的MTU值继续发送报文。如此反复，直到报文到达目的地之后，源节点就能知道到达目的地的PMTU了。

![image-20231105131415669](images\image-20231105131415669.png)

## 六 IPV6配置

```
Router(config)# ipv6 unicast-routing  // 启用IPv6路由功
Router(config)#in g 0/1
Router(config-if)#ipv6 address 2324:2187:6A::/64 //配置对于PC的IPV6网关
Router(config-if)#NO SH
Router(config-if)#IN G 0/0
Router(config-if)#ipv6 address 2324:2187:6B::/64
Router(config-if)#NO SH
Router(config-if)#IN G 0/2
Router(config-if)#NO SH
 
Router(config-if)#ipv6 address 2324:2187:6C::/64
Router(config-if)# show ipv6 interface GigabitEthernet0/0/0
Router(config)#DO SH IPV ROU  //查看一下路由器上接收到的IPV6地址
IPv6 Routing Table - 7 entries
Codes: C - Connected, L - Local, S - Static, R - RIP, B - BGP
       U - Per-user Static route, M - MIPv6
       I1 - ISIS L1, I2 - ISIS L2, IA - ISIS interarea, IS - ISIS summary
       ND - ND Default, NDp - ND Prefix, DCE - Destination, NDr - Redirect
       O - OSPF intra, OI - OSPF inter, OE1 - OSPF ext 1, OE2 - OSPF ext 2
       ON1 - OSPF NSSA ext 1, ON2 - OSPF NSSA ext 2
       D - EIGRP, EX - EIGRP external
C   2324:2187:6A::/64 [0/0]
     via GigabitEthernet0/1, directly connected
L   2324:2187:6A::/128 [0/0]
     via GigabitEthernet0/1, receive
C   2324:2187:6B::/64 [0/0]
     via GigabitEthernet0/0, directly connected
L   2324:2187:6B::/128 [0/0]
     via GigabitEthernet0/0, receive
C   2324:2187:6C::/64 [0/0]
     via GigabitEthernet0/2, directly connected
L   2324:2187:6C::/128 [0/0]
     via GigabitEthernet0/2, receive  //这边可以看到一经接收到ABC段的IPV6    地址了
L   FF00::/8 [0/0]


```

### 配置IPV6-eiu地址

```
配置路由器R1接口EUI-64地址（R2配置相同）
R1(config)#ipv6 unicast-routing
R1(config-if)#interface GigabitEthernet 0/2
R1(config-if)#ipv6 address 2188:6401:4:E::/64 eui-64
R1(config-if)#no shutdown
 
配置IPv6静态路由
配置R1静态路由
R1(config)#ipv6 route 2188:6401:4:C::/64 2188:6401:4:E:2D0:BAFF:FE2C:48D6
R1(config)#ipv6 route 2188:6401:4:D::/64 2188:6401:4:E:2D0:BAFF:FE2C:48D6
配置R2静态路由
R2(config)#ipv6 route 2188:6401:4:A::/64 2188:6401:4:E:20A:41FF:FEAB:EBEB
R2(config)#ipv6 route 2188:6401:4:B::/64 2188:6401:4:E:20A:41FF:FEAB:EBE
```

### 配置RIPng路由

```
Router(config)#ipv router rip 1  //创建RIPng进程1
Router(config-rtr)#in g0/0  进入g0/0端口
Router(config-if)#ipv6 rip 1 enable 启用RIPng进程1
```

### 配置OSPFV3动态路由

```
OSPFV3配置：
Router(config)#ipv6 router ospf 1  //创建OSPFV3进程1
Router(config-rtr)#router-id 1.1.1.1 //指定路由器ID
Router(config-rtr)#in g 0/1
Router(config-if)#ipv6 ospf 1 area 1  //启用OSPF进程1 将这个接口加入区域
```

 
